<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨äº¤æ˜“æ™ºèƒ½ä½“ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .chat-container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .chat-header {
            text-align: center;
            padding: 20px;
            border-bottom: 2px solid #007bff;
            margin-bottom: 20px;
        }
        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
            margin-left: 20%;
        }
        .bot-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        .query-input {
            display: flex;
            gap: 10px;
        }
        .query-input input {
            flex: 1;
        }
        .result-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .prediction-chart {
            margin-top: 20px;
        }
        /* è®­ç»ƒ-é¢„æµ‹æµç¨‹æ­¥éª¤å›¾æ ·å¼ */
        .process-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 20px 0;
            gap: 10px;
        }
        .process-step {
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        .process-step.completed {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }
        .process-step.pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: #ffc107;
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);
        }
        .step-icon {
            font-size: 3em;
            margin-bottom: 10px;
            line-height: 1;
            display: block;
        }
        .step-content h6 {
            font-weight: bold;
            margin-bottom: 8px;
            color: #212529;
        }
        .step-content p {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }
        .step-content small {
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
        }
        .step-arrow {
            font-size: 2em;
            color: #6c757d;
            margin: 0 5px;
            flex-shrink: 0;
        }
        @media (max-width: 768px) {
            .process-flow {
                flex-direction: column;
            }
            .step-arrow {
                transform: rotate(90deg);
                margin: 10px 0;
            }
            .process-step {
                max-width: 100%;
                width: 100%;
            }
        }
        .rule-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .rule-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }
        .rule-item.triggered {
            border-left-color: #dc3545;
            background-color: #fff5f5;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .rules-list-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .rule-bar-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .rule-bar-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .rule-bar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .rule-id-badge {
            background-color: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .rule-name {
            color: #212529;
            font-size: 1rem;
            flex: 1;
        }
        .rule-type-badge {
            background-color: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .rule-bar-body {
            padding-left: 0;
        }
        .rule-description {
            color: #6c757d;
            font-size: 0.9rem;
            margin: 0;
        }
        .rule-action {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #dee2e6;
        }
        .action-type {
            color: #dc3545;
            font-weight: bold;
            font-size: 0.85rem;
        }
        .action-message {
            color: #495057;
            font-size: 0.9rem;
        }
        .position-card {
            max-width: 1200px;
            margin: 20px auto 0;
        }
        .position-card .table {
            margin-bottom: 0;
        }
        .position-card .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .position-card .table td {
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .rule-triggered {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 3px solid #28a745;
        }
        .rule-match-mark {
            color: #28a745;
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: auto;
        }
        .chart-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .chart-box {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .chart-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        .technical-analysis-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .technical-analysis-card h6 {
            color: white;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .analysis-item {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }
        .analysis-item strong {
            color: #fff;
        }
        .chart-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ai-analysis {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 60px;
        }
        .ai-analysis-label {
            display: inline-block;
            white-space: nowrap;
            font-weight: bold;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .ai-analysis-content {
            display: inline;
            word-wrap: break-word;
            word-break: break-word;
        }
        .ai-analysis.loading {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .ai-analysis.loading::before {
            content: 'ğŸ¤– AIæ­£åœ¨åˆ†æä¸­...';
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .evidence-item {
            background-color: #e3f2fd;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #2196f3;
            line-height: 1.6;
        }
        .final-decision {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 1.05rem;
            line-height: 1.8;
        }
        .final-decision-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æŒä»“ä¿¡æ¯å¡ç‰‡ -->
        <div class="position-card" id="positionCard" style="display: none;">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ğŸ’¼ æˆ‘çš„æŒä»“</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-3">
                            <strong>æ€»èµ„äº§ï¼š</strong><span id="totalAssets" class="text-success">--</span>
                        </div>
                        <div class="col-md-3">
                            <strong>å¯ç”¨èµ„é‡‘ï¼š</strong><span id="availableCash" class="text-info">--</span>
                        </div>
                        <div class="col-md-3">
                            <strong>æŒä»“ä»·å€¼ï¼š</strong><span id="positionValue" class="text-primary">--</span>
                        </div>
                        <div class="col-md-3">
                            <strong>æ€»ç›ˆäºï¼š</strong><span id="totalProfit" class="text-danger">--</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>è‚¡ç¥¨ä»£ç </th>
                                    <th>è‚¡ç¥¨åç§°</th>
                                    <th>æŒä»“æ•°é‡</th>
                                    <th>æˆæœ¬ä»·</th>
                                    <th>å½“å‰ä»·</th>
                                    <th>æŒä»“ä»·å€¼</th>
                                    <th>ç›ˆäº</th>
                                    <th>ç›ˆäºç‡</th>
                                </tr>
                            </thead>
                            <tbody id="positionTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h2>ğŸ“ˆ è‚¡ç¥¨äº¤æ˜“æ™ºèƒ½ä½“ç³»ç»Ÿ</h2>
                <p class="text-muted">æ™ºèƒ½é¢„æµ‹ Â· è§„åˆ™å¼•æ“ Â· å†³ç­–æ”¯æŒ</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <strong>ç³»ç»Ÿï¼š</strong> æ‚¨å¥½ï¼æˆ‘æ˜¯è‚¡ç¥¨äº¤æ˜“æ™ºèƒ½ä½“ï¼Œå¯ä»¥å¸®æ‚¨é¢„æµ‹è‚¡ç¥¨èµ°åŠ¿å¹¶åšå‡ºäº¤æ˜“å†³ç­–ã€‚<br>
                    æ‚¨å¯ä»¥è¿™æ ·æé—®ï¼š<br>
                    â€¢ "å¸®æˆ‘é¢„æµ‹ä¸€ä¸ªè‚¡ç¥¨çš„èµ°åŠ¿ï¼Œè‚¡ç¥¨ä»£ç æ˜¯ 000560"<br>
                    â€¢ "000560è¿™åªè‚¡ç¥¨å¯ä»¥ä¹°å…¥å—ï¼Ÿ"<br>
                    â€¢ "åˆ†æä¸€ä¸‹600519çš„å‰æ™¯"
                </div>
            </div>

            <div class="query-input">
                <input type="text" class="form-control" id="queryInput" 
                       placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                       onkeypress="if(event.key === 'Enter') handleQuery()">
                <button class="btn btn-primary" onclick="handleQuery()">å‘é€</button>
            </div>

            <div id="resultContainer" class="result-section" style="display: none;">
                <h5>ğŸ“Š åˆ†æç»“æœ</h5>
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–æŒä»“ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', function() {
            loadPositionInfo();
            // ä¸å†è‡ªåŠ¨åˆ·æ–°ï¼Œç”¨æˆ·éœ€è¦æ—¶å¯ä»¥æ‰‹åŠ¨åˆ·æ–°
        });

        function loadPositionInfo() {
            fetch('/api/account')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        displayPositionInfo(data.data);
                    } else {
                        console.error('è·å–æŒä»“ä¿¡æ¯å¤±è´¥:', data.message);
                    }
                })
                .catch(error => {
                    console.error('è¯·æ±‚æŒä»“ä¿¡æ¯å¤±è´¥:', error);
                });
        }

        function displayPositionInfo(accountData) {
            // æ˜¾ç¤ºæŒä»“å¡ç‰‡
            document.getElementById('positionCard').style.display = 'block';

            // æ›´æ–°è´¦æˆ·æ‘˜è¦
            document.getElementById('totalAssets').textContent = 'ï¿¥' + formatNumber(accountData.total_assets);
            document.getElementById('availableCash').textContent = 'ï¿¥' + formatNumber(accountData.available_cash);
            document.getElementById('positionValue').textContent = 'ï¿¥' + formatNumber(accountData.total_position_value);
            
            const profit = accountData.total_profit || 0;
            const profitElement = document.getElementById('totalProfit');
            profitElement.textContent = 'ï¿¥' + formatNumber(profit);
            profitElement.className = profit >= 0 ? 'text-success' : 'text-danger';

            // æ›´æ–°æŒä»“è¡¨æ ¼
            const tbody = document.getElementById('positionTableBody');
            const positions = accountData.positions || {};
            
            if (Object.keys(positions).length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— æŒä»“</td></tr>';
                return;
            }

            let html = '';
            for (const [stockCode, position] of Object.entries(positions)) {
                const shares = position.shares || 0;
                const cost = position.cost || 0;
                const currentPrice = position.current_price || 0;
                const positionValue = position.position_value || 0;
                const profit = position.profit || 0;
                const profitRatio = position.profit_ratio || 0;
                const stockName = position.stock_name || stockCode;

                html += `
                    <tr>
                        <td><strong>${stockCode}</strong></td>
                        <td>${stockName}</td>
                        <td>${formatNumber(shares)}è‚¡</td>
                        <td>ï¿¥${cost.toFixed(2)}</td>
                        <td>ï¿¥${currentPrice.toFixed(2)}</td>
                        <td>ï¿¥${formatNumber(positionValue)}</td>
                        <td style="color: ${profit >= 0 ? 'red' : 'green'};">
                            ${profit >= 0 ? '+' : ''}ï¿¥${formatNumber(profit)}
                        </td>
                        <td style="color: ${profitRatio >= 0 ? 'red' : 'green'};">
                            ${profitRatio >= 0 ? '+' : ''}${(profitRatio * 100).toFixed(2)}%
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = html;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return Number(num).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function addMessage(text, isUser = false) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            messageDiv.innerHTML = `<strong>${isUser ? 'æ‚¨' : 'æ™ºèƒ½ä½“'}ï¼š</strong>${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleQuery() {
            const input = document.getElementById('queryInput');
            const query = input.value.trim();
            
            if (!query) {
                alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(query, true);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = 'â³ æ­£åœ¨åˆ†æä¸­...';
            document.getElementById('chatMessages').appendChild(loadingDiv);

            // å‘é€è¯·æ±‚
            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤åŠ è½½çŠ¶æ€
                document.getElementById('loadingIndicator').remove();

                if (data.success) {
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(data);
                    addMessage(`âœ… å·²æˆåŠŸåˆ†æè‚¡ç¥¨ ${data.stock_code}ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹è¯¦ç»†ç»“æœã€‚`, false);
                } else {
                    addMessage(`âŒ ${data.message}`, false);
                }
            })
            .catch(error => {
                document.getElementById('loadingIndicator').remove();
                addMessage(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            });
        }

        function handleMultiModelPredict() {
            const input = document.getElementById('queryInput');
            const query = input.value.trim();
            
            // ä»æŸ¥è¯¢ä¸­æå–è‚¡ç¥¨ä»£ç 
            const stockCodeMatch = query.match(/([0-9]{6})/);
            let stockCode = stockCodeMatch ? stockCodeMatch[1] : '';
            
            if (!stockCode) {
                alert('è¯·å…ˆè¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š000560ï¼‰');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(`å¤šæ¨¡å‹é¢„æµ‹ï¼š${stockCode}`, true);
            input.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = 'â³ æ­£åœ¨ä½¿ç”¨å¤šç§ç®—æ³•è¿›è¡Œé¢„æµ‹...';
            document.getElementById('chatMessages').appendChild(loadingDiv);

            // å‘é€å¤šæ¨¡å‹é¢„æµ‹è¯·æ±‚
            fetch('/api/multi-model-predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ stock_code: stockCode })
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤åŠ è½½çŠ¶æ€
                document.getElementById('loadingIndicator').remove();

                if (data.success) {
                    // æ˜¾ç¤ºå¤šæ¨¡å‹é¢„æµ‹ç»“æœ
                    displayMultiModelResults(data);
                    addMessage(`âœ… å·²ä½¿ç”¨ ${Object.keys(data.predictions || {}).length} ç§ç®—æ³•å®Œæˆé¢„æµ‹ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹è¯¦ç»†ç»“æœã€‚`, false);
                } else {
                    addMessage(`âŒ ${data.message}`, false);
                }
            })
            .catch(error => {
                document.getElementById('loadingIndicator').remove();
                addMessage(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, false);
            });
        }

        function displayResult(data) {
            const container = document.getElementById('resultContainer');
            const content = document.getElementById('resultContent');
            container.style.display = 'block';

            const decision = data.decision || {};
            const prediction = data.prediction || {};
            const visualization = data.visualization || {};
            const stockCode = data.stock_code;
            const hasMultiModel = data.has_multi_model_prediction && data.multi_model_prediction;
            
            // åªè¦æœ‰è‚¡ç¥¨ä»£ç ï¼Œå°±ä½¿ç”¨Tabé¡µç»“æ„ï¼ˆå³ä½¿æ²¡æœ‰å¤šæ¨¡å‹é¢„æµ‹æ•°æ®ï¼Œä¹Ÿæ˜¾ç¤ºä¸¤ä¸ªTabï¼‰
            if (stockCode) {
                console.log('[displayResult] æ£€æµ‹åˆ°è‚¡ç¥¨ä»£ç :', stockCode);
                console.log('[displayResult] æ•°æ®å¯¹è±¡:', { 
                    hasDecision: !!decision, 
                    hasPrediction: !!prediction, 
                    hasVisualization: !!visualization,
                    hasStockData: !!(data.stock_data && data.stock_data.length > 0)
                });
                
                // å¦‚æœæ²¡æœ‰å¤šæ¨¡å‹é¢„æµ‹æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„é¢„æµ‹æ•°æ®ç»“æ„
                const multiModelData = hasMultiModel ? data.multi_model_prediction : {
                    predictions: {},
                    training_results: {},
                    model_info: { model_count: 0 },
                    training_status: {
                        trained_count: 0,
                        total_models: 0,
                        has_training: false,
                        training_progress: 0,
                        data_days: 0,
                        min_required: 68,
                        min_recommended: 75,
                        data_sufficient: false
                    },
                    progress_id: null
                };
                
                // ç”Ÿæˆç¬¬ä¸€ä¸ªTabçš„å†…å®¹
                let quantitativeHTML;
                try {
                    quantitativeHTML = generateQuantitativeAnalysisHTML(data, decision, prediction, visualization);
                    console.log('[displayResult] é‡åŒ–åˆ†æHTMLç”ŸæˆæˆåŠŸï¼Œé•¿åº¦:', quantitativeHTML ? quantitativeHTML.length : 0);
                } catch (e) {
                    console.error('[displayResult] ç”Ÿæˆé‡åŒ–åˆ†æHTMLå¤±è´¥:', e);
                    quantitativeHTML = '<div class="alert alert-danger">ç”Ÿæˆé‡åŒ–åˆ†æå†…å®¹æ—¶å‡ºé”™: ' + e.message + '</div>';
                }
                
                // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤å†…å®¹
                if (!quantitativeHTML || quantitativeHTML.trim().length === 0) {
                    console.warn('[displayResult] é‡åŒ–åˆ†æHTMLä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å†…å®¹');
                    quantitativeHTML = '<div class="alert alert-info">æ­£åœ¨åŠ è½½é‡åŒ–åˆ†ææ•°æ®...</div>';
                }
                
                // æ³¨æ„ï¼šä¸å†åœ¨è¿™é‡Œå¼‚æ­¥è·å–æ•°æ®ï¼Œè€Œæ˜¯åœ¨ç”¨æˆ·ç‚¹å‡»Tabæ—¶è§¦å‘è®­ç»ƒ
                // è¿™æ ·å¯ä»¥é¿å…åœ¨æŸ¥è¯¢æ—¶å°±è§¦å‘è®­ç»ƒï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°é‡åŒ–åˆ†æç»“æœ
                let html = `
                    <!-- Tabå¯¼èˆª -->
                    <ul class="nav nav-tabs mb-3" id="analysisTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="quantitative-tab" data-bs-toggle="tab" 
                                    data-bs-target="#quantitative-panel" type="button" role="tab" 
                                    aria-controls="quantitative-panel" aria-selected="true">
                                ğŸ“Š è‚¡ç¥¨æ•°æ®é‡åŒ–åˆ†æ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="prediction-tab" data-bs-toggle="tab" 
                                    data-bs-target="#prediction-panel" type="button" role="tab" 
                                    aria-controls="prediction-panel" aria-selected="false">
                                ğŸ¤– è‚¡ä»·é¢„æµ‹
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tabå†…å®¹ -->
                    <div class="tab-content" id="analysisTabContent">
                        <!-- ç¬¬ä¸€ä¸ªTabï¼šè‚¡ç¥¨æ•°æ®é‡åŒ–åˆ†æ -->
                        <div class="tab-pane fade show active" id="quantitative-panel" role="tabpanel" 
                             aria-labelledby="quantitative-tab">
                            ${quantitativeHTML}
                        </div>
                        
                        <!-- ç¬¬äºŒä¸ªTabï¼šè‚¡ä»·é¢„æµ‹ -->
                        <div class="tab-pane fade" id="prediction-panel" role="tabpanel" 
                             aria-labelledby="prediction-tab">
                            ${generatePredictionHTML(multiModelData, stockCode)}
                        </div>
                    </div>
                `;
                console.log('[displayResult] å‡†å¤‡è®¾ç½®HTMLï¼Œé•¿åº¦:', html.length);
                console.log('[displayResult] HTMLå‰500å­—ç¬¦:', html.substring(0, 500));
                content.innerHTML = html;
                console.log('[displayResult] HTMLå·²è®¾ç½®ï¼Œcontent.innerHTMLé•¿åº¦:', content.innerHTML.length);
                
                // ç¡®ä¿Tabæ­£ç¡®åˆå§‹åŒ–
                setTimeout(() => {
                    // æ£€æŸ¥Tabå…ƒç´ æ˜¯å¦å­˜åœ¨
                    const quantitativeTab = document.getElementById('quantitative-tab');
                    const quantitativePanel = document.getElementById('quantitative-panel');
                    const predictionTab = document.getElementById('prediction-tab');
                    const predictionPanel = document.getElementById('prediction-panel');
                    
                    console.log('[Tabæ£€æŸ¥] é‡åŒ–åˆ†æTab:', quantitativeTab ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    console.log('[Tabæ£€æŸ¥] é‡åŒ–åˆ†æPanel:', quantitativePanel ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    console.log('[Tabæ£€æŸ¥] è‚¡ä»·é¢„æµ‹Tab:', predictionTab ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    console.log('[Tabæ£€æŸ¥] è‚¡ä»·é¢„æµ‹Panel:', predictionPanel ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    
                    // ç¡®ä¿ç¬¬ä¸€ä¸ªTabæ˜¯æ¿€æ´»çŠ¶æ€
                    if (quantitativeTab && quantitativePanel) {
                        // æ£€æŸ¥Panelæ˜¯å¦å¯è§
                        console.log('[Tabæ£€æŸ¥] é‡åŒ–åˆ†æPanelçš„classList:', quantitativePanel.classList.toString());
                        console.log('[Tabæ£€æŸ¥] é‡åŒ–åˆ†æPanelçš„style.display:', quantitativePanel.style.display);
                        console.log('[Tabæ£€æŸ¥] é‡åŒ–åˆ†æPanelçš„offsetHeight:', quantitativePanel.offsetHeight);
                        
                        // ç¡®ä¿Panelæœ‰æ­£ç¡®çš„ç±»
                        if (!quantitativePanel.classList.contains('show')) {
                            quantitativePanel.classList.add('show', 'active');
                        }
                        if (!quantitativeTab.classList.contains('active')) {
                            quantitativeTab.classList.add('active');
                        }
                        
                        // ä½¿ç”¨Bootstrapçš„Tab APIæ¿€æ´»ç¬¬ä¸€ä¸ªTab
                        try {
                            const bsTab = new bootstrap.Tab(quantitativeTab);
                            bsTab.show();
                            console.log('[Tabæ£€æŸ¥] å·²æ¿€æ´»é‡åŒ–åˆ†æTab (Bootstrap API)');
                        } catch (e) {
                            console.warn('[Tabæ£€æŸ¥] Bootstrap Tab APIå¤±è´¥ï¼Œä½¿ç”¨æ‰‹åŠ¨æ¿€æ´»:', e);
                            // æ‰‹åŠ¨æ¿€æ´»
                            quantitativeTab.classList.add('active');
                            quantitativePanel.classList.add('show', 'active');
                            // ç§»é™¤å…¶ä»–Tabçš„activeç±»
                            if (predictionTab) predictionTab.classList.remove('active');
                            if (predictionPanel) predictionPanel.classList.remove('show', 'active');
                        }
                    } else {
                        console.error('[Tabæ£€æŸ¥] é‡åŒ–åˆ†æTabæˆ–Panelä¸å­˜åœ¨ï¼');
                        console.error('[Tabæ£€æŸ¥] quantitativeTab:', quantitativeTab);
                        console.error('[Tabæ£€æŸ¥] quantitativePanel:', quantitativePanel);
                    }
                    
                    // ç›‘å¬Tabåˆ‡æ¢äº‹ä»¶ï¼Œå½“ç‚¹å‡»"è‚¡ä»·é¢„æµ‹"Tabæ—¶è§¦å‘è®­ç»ƒ
                    let trainingTriggered = false;
                    
                    if (predictionTab && predictionPanel) {
                        predictionTab.addEventListener('shown.bs.tab', function() {
                            console.log('[Tabåˆ‡æ¢] ç”¨æˆ·ç‚¹å‡»äº†è‚¡ä»·é¢„æµ‹Tab');
                            // åªåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶è§¦å‘è®­ç»ƒ
                            if (!trainingTriggered) {
                                trainingTriggered = true;
                                const stockCodeForTraining = stockCode;
                                const currentMultiModelData = multiModelData;
                                
                                // å¦‚æœè¿˜æ²¡æœ‰è®­ç»ƒæ•°æ®ï¼Œå¼€å§‹è®­ç»ƒ
                                if (!currentMultiModelData.predictions || Object.keys(currentMultiModelData.predictions).length === 0) {
                                    console.log('[Tabåˆ‡æ¢] å¼€å§‹è®­ç»ƒæ¨¡å‹');
                                    startModelTraining(stockCodeForTraining);
                                }
                            }
                        });
                    }
                }, 100);
                
                // æ˜¾ç¤ºæ•°æ®æºä¿¡æ¯
                displayDataSourceBadge(data);
                
                // ç»˜åˆ¶å›¾è¡¨
                setTimeout(() => {
                    if (data.stock_data && data.stock_data.length > 0) {
                        drawTechnicalCharts(data.stock_data, data.stock_code);
                        generateTechnicalAnalysis(data.stock_data);
                    }
                    // ç§»é™¤ä»·æ ¼é¢„æµ‹è¶‹åŠ¿å›¾è¡¨ç»˜åˆ¶ï¼ˆç”¨æˆ·è¦æ±‚åˆ é™¤ï¼‰
                    // ç”Ÿæˆå†³ç­–è§£é‡Š
                    generateDecisionExplanation(data);
                }, 100);
                
                // æ³¨æ„ï¼šä¸å†åœ¨è¿™é‡Œè°ƒç”¨ displayMultiModelResultsï¼Œå› ä¸ºç°åœ¨å¤šæ¨¡å‹é¢„æµ‹ç»“æœåº”è¯¥åœ¨ç¬¬äºŒä¸ªTabä¸­æ˜¾ç¤º
                // å¦‚æœæœ‰å¤šæ¨¡å‹é¢„æµ‹æ•°æ®ï¼Œå®ƒå·²ç»åœ¨ç¬¬äºŒä¸ªTabä¸­æ˜¾ç¤ºäº†
                // displayMultiModelResults åªåº”è¯¥åœ¨ç¬¬äºŒä¸ªTabå†…éƒ¨è°ƒç”¨ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œ
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                container.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            // å¦‚æœæ²¡æœ‰å¤šæ¨¡å‹é¢„æµ‹ï¼Œä½¿ç”¨åŸæ¥çš„å•é¢æ¿æ˜¾ç¤º
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>ğŸ¯ å†³ç­–å»ºè®®</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>æ“ä½œï¼š</strong> 
                                    <span class="badge bg-${decision.action === 'ä¹°å…¥' ? 'success' : decision.action === 'å–å‡º' ? 'danger' : 'secondary'}">
                                        ${decision.action || 'æœªçŸ¥'}
                                    </span>
                                </p>
                                <p><strong>å½“å‰ä»·æ ¼ï¼š</strong> ï¿¥${decision.current_price?.toFixed(2) || 'N/A'}</p>
                                ${decision.suggested_shares ? `
                                    <p><strong>å»ºè®®æ•°é‡ï¼š</strong> ${decision.suggested_shares}è‚¡</p>
                                    <p><strong>å»ºè®®é‡‘é¢ï¼š</strong> ï¿¥${decision.suggested_amount?.toFixed(2) || 'N/A'}</p>
                                ` : ''}
                                <p><strong>å»ºè®®ç†ç”±ï¼š</strong> ${decision.suggestion || 'æ— '}</p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>ğŸ“ˆ é¢„æµ‹ç»“æœ</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>é¢„æµ‹è¶‹åŠ¿ï¼š</strong> ${prediction.trend || 'æœªçŸ¥'}</p>
                                <p><strong>é¢„æœŸæ”¶ç›Šç‡ï¼š</strong> 
                                    <span style="color: ${prediction.predicted_return_pct > 0 ? 'red' : 'green'}">
                                        ${prediction.predicted_return_pct?.toFixed(2) || 0}%
                                    </span>
                                </p>
                                <p><strong>ç½®ä¿¡åº¦ï¼š</strong> ${(prediction.confidence * 100)?.toFixed(1) || 0}%</p>
                                <p><strong>é£é™©ç­‰çº§ï¼š</strong> 
                                    <span class="badge bg-${prediction.risk_level === 'ä½' ? 'success' : prediction.risk_level === 'ä¸­' ? 'warning' : 'danger'}">
                                        ${prediction.risk_level || 'æœªçŸ¥'}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>âš™ï¸ è§„åˆ™è¯„ä¼°</h6>
                            </div>
                            <div class="card-body">
                                ${visualization.steps && visualization.steps.length > 0 ? `
                                    <div class="rules-list-container mb-3">
                                        <strong class="d-block mb-2">æ‰€æœ‰è§„åˆ™åˆ—è¡¨ï¼ˆåŒ¹é…çš„è§„åˆ™ç”¨ç»¿è‰²âˆšæ ‡è®°ï¼‰ï¼š</strong>
                                        ${visualization.steps.map(step => `
                                            <div class="rule-bar-item ${step.is_triggered ? 'rule-triggered' : ''}">
                                                <div class="rule-bar-header">
                                                    <span class="rule-id-badge">${step.rule_id || ''}</span>
                                                    <strong class="rule-name">${step.rule_name || ''}</strong>
                                                    <span class="rule-type-badge">${step.rule_type || ''}</span>
                                                    ${step.is_triggered ? '<span class="rule-match-mark">âœ“</span>' : ''}
                                                </div>
                                                <div class="rule-bar-body">
                                                    <p class="rule-description mb-1">${step.description || ''}</p>
                                                    ${step.action && step.action.message ? `
                                                        <p class="rule-action mb-0">
                                                            <span class="action-type">${step.action.type || ''}ï¼š</span>
                                                            <span class="action-message">${step.action.message || ''}</span>
                                                        </p>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div class="alert alert-info mb-3">æœªæ‰¾åˆ°ä»»ä½•è§„åˆ™</div>'}
                                <div class="rule-summary">
                                    <p><strong>è§¦å‘è§„åˆ™æ•°ï¼š</strong> ${visualization.triggered_rules || 0} / ${visualization.total_rules || 0}</p>
                                    <p><strong>è¯„ä¼°ç»“æœï¼š</strong> 
                                        <span class="badge bg-${visualization.is_allowed ? 'success' : 'danger'}">
                                            ${visualization.is_allowed ? 'å…è®¸' : 'ç¦æ­¢'}
                                        </span>
                                    </p>
                                    ${!visualization.is_allowed && visualization.reason ? `
                                        <p class="text-danger mt-2"><strong>åŸå› ï¼š</strong> ${visualization.reason}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨åŒºåŸŸï¼ˆæ”¾åœ¨å†³ç­–è§£é‡Šä¸Šæ–¹ï¼‰
            if (data.stock_data && data.stock_data.length > 0) {
                html += `
                    <div class="card mt-3">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">ğŸ“Š æŠ€æœ¯æŒ‡æ ‡ï¼ˆé‡åŒ–æŒ‡æ ‡ï¼‰<span id="dataSourceBadge" class="badge ms-2" style="font-size: 0.7em;"></span></h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <div class="chart-wrapper">
                                    <div id="klineChart" class="chart-box"></div>
                                    <div id="klineAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="macdChart" class="chart-box"></div>
                                    <div id="macdAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="rsiChart" class="chart-box"></div>
                                    <div id="rsiAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="bollingerChart" class="chart-box"></div>
                                    <div id="bollingerAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="kdjChart" class="chart-box"></div>
                                    <div id="kdjAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="volumeChart" class="chart-box"></div>
                                    <div id="volumeAnalysis" class="ai-analysis"></div>
                                </div>
                            </div>
                            <div id="technicalAnalysis" class="mt-3"></div>
                        </div>
                    </div>
                `;
            }
            
            // å¦‚æœæœ‰é¢„æµ‹æ•°æ®ï¼Œæ˜¾ç¤ºå›¾è¡¨
            if (prediction.predictions && prediction.predictions.length > 0) {
                html += '<div class="prediction-chart mt-3"><div id="predictionChart"></div></div>';
            }
            
            // æ·»åŠ å†³ç­–è§£é‡Šï¼ˆåœ¨æŠ€æœ¯æŒ‡æ ‡ä¸‹æ–¹ï¼‰
            html += `
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>ğŸ’¡ å†³ç­–è§£é‡Š</h6>
                    </div>
                    <div class="card-body">
                        <div id="decisionExplanation">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                                <p class="mt-2">æ­£åœ¨ç”Ÿæˆå†³ç­–è§£é‡Š...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // æ˜¾ç¤ºæ•°æ®æºä¿¡æ¯
            const dataSourceBadge = document.getElementById('dataSourceBadge');
            if (dataSourceBadge) {
                const isRealData = data.data_source && data.data_source !== 'mock';
                // å¦‚æœæ•°æ®æºæ˜¾ç¤ºä¸ºç©ºï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰ï¼Œä¸æ˜¾ç¤ºæ–‡å­—ï¼Œåªæ˜¾ç¤ºé¢œè‰²æ ‡è¯†
                if (data.data_source_display && data.data_source_display.trim() !== '') {
                    dataSourceBadge.textContent = data.data_source_display;
                    dataSourceBadge.className = `badge ms-2 ${isRealData ? 'bg-success' : 'bg-warning'}`;
                    dataSourceBadge.style.fontSize = '0.7em';
                    dataSourceBadge.title = isRealData ? 'è¿™æ˜¯ä»çœŸå®æ•°æ®æºè·å–çš„æ•°æ®' : 'è¿™æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›å‚è€ƒ';
                } else if (data.data_source === 'mock') {
                    // æ¨¡æ‹Ÿæ•°æ®ï¼šåªæ˜¾ç¤ºé»„è‰²åœ†ç‚¹ï¼Œä¸æ˜¾ç¤ºæ–‡å­—
                    dataSourceBadge.textContent = '';
                    dataSourceBadge.className = 'badge ms-2 bg-warning';
                    dataSourceBadge.style.width = '12px';
                    dataSourceBadge.style.height = '12px';
                    dataSourceBadge.style.borderRadius = '50%';
                    dataSourceBadge.style.padding = '0';
                    dataSourceBadge.title = 'è¿™æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›å‚è€ƒ';
                } else {
                    // éšè—å¾½ç« 
                    dataSourceBadge.style.display = 'none';
                }
            }
            
            // ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
            setTimeout(() => {
                if (data.stock_data && data.stock_data.length > 0) {
                    drawTechnicalCharts(data.stock_data, data.stock_code);
                    generateTechnicalAnalysis(data.stock_data);
                }
                if (prediction.predictions && prediction.predictions.length > 0) {
                    drawPredictionChart(prediction);
                }
                
                // ç”Ÿæˆå†³ç­–è§£é‡Š
                generateDecisionExplanation(data);
            }, 100);

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸ºç®€æ´å½¢å¼ï¼ˆ9/21, 9/22ï¼‰
        function formatDateSimple(dateStr) {
            if (!dateStr) return '';
            try {
                let date;
                if (dateStr instanceof Date) {
                    date = dateStr;
                } else if (typeof dateStr === 'string') {
                    // å°è¯•è§£æå„ç§æ—¥æœŸæ ¼å¼
                    if (dateStr.includes('T')) {
                        date = new Date(dateStr);
                    } else if (dateStr.includes('-')) {
                        date = new Date(dateStr);
                    } else {
                        date = new Date(dateStr);
                    }
                } else {
                    return String(dateStr);
                }
                
                if (isNaN(date.getTime())) {
                    return String(dateStr);
                }
                
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            } catch (e) {
                return String(dateStr);
            }
        }
        
        function drawTechnicalCharts(stockData, stockCode) {
            // å‡†å¤‡æ•°æ® - ä¿æŒæ•°æ®é•¿åº¦ä¸€è‡´ï¼Œä½¿ç”¨ç´¢å¼•å¯¹é½
            const validData = stockData.filter(d => (d.date || d.Date) && d.close !== null && d.close !== undefined);
            const dates = validData.map(d => {
                const date = d.date || d.Date || '';
                return formatDateSimple(date);
            });
            
            // ç¡®ä¿ä»·æ ¼æ•°æ®æ˜¯æ•°å­—ç±»å‹ï¼Œå¹¶å¤„ç†å¯èƒ½çš„å•ä½é—®é¢˜
            // å…ˆæ£€æŸ¥ä»·æ ¼èŒƒå›´ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å•ä½è½¬æ¢
            const samplePrices = validData.slice(0, 10).map(d => parseFloat(d.close) || 0).filter(p => p > 0);
            const avgSamplePrice = samplePrices.length > 0 ? samplePrices.reduce((a, b) => a + b, 0) / samplePrices.length : 0;
            // Aè‚¡æ­£å¸¸ä»·æ ¼åœ¨0.01-1000å…ƒä¹‹é—´ï¼Œå¦‚æœå¹³å‡ä»·æ ¼åœ¨100-10000ä¹‹é—´ï¼Œå¾ˆå¯èƒ½æ˜¯ä»¥"åˆ†"ä¸ºå•ä½
            const needConvert = avgSamplePrice > 100 && avgSamplePrice < 10000;
            
            if (needConvert && samplePrices.length > 0) {
                console.log(`[å‰ç«¯] æ£€æµ‹åˆ°ä»·æ ¼å¯èƒ½éœ€è¦å•ä½è½¬æ¢ï¼Œå¹³å‡ä»·æ ¼: ${avgSamplePrice.toFixed(2)}ï¼Œå°†é™¤ä»¥100è½¬æ¢ä¸ºå…ƒ`);
            } else if (samplePrices.length > 0) {
                console.log(`[å‰ç«¯] ä»·æ ¼å•ä½æ­£å¸¸ï¼Œå¹³å‡ä»·æ ¼: ${avgSamplePrice.toFixed(2)}å…ƒ`);
            }
            
            const closes = validData.map(d => {
                let price = parseFloat(d.close) || 0;
                if (needConvert && price > 0) {
                    price = price / 100;
                }
                return price;
            });
            const opens = validData.map(d => {
                let price = parseFloat(d.open) || 0;
                if (needConvert && price > 0) {
                    price = price / 100;
                }
                return price;
            });
            const highs = validData.map(d => {
                let price = parseFloat(d.high) || 0;
                if (needConvert && price > 0) {
                    price = price / 100;
                }
                return price;
            });
            const lows = validData.map(d => {
                let price = parseFloat(d.low) || 0;
                if (needConvert && price > 0) {
                    price = price / 100;
                }
                return price;
            });
            
            // è¾“å‡ºä»·æ ¼èŒƒå›´ç”¨äºè°ƒè¯•
            if (closes.length > 0) {
                const minPrice = Math.min(...closes.filter(p => p > 0));
                const maxPrice = Math.max(...closes.filter(p => p > 0));
                console.log(`[å‰ç«¯] å¤„ç†åçš„ä»·æ ¼èŒƒå›´: ${minPrice.toFixed(2)} - ${maxPrice.toFixed(2)}`);
            }
            const volumes = validData.map(d => d.volume || 0);
            
            // æŠ€æœ¯æŒ‡æ ‡æ•°æ® - ä¸validDataä¿æŒç›¸åŒç´¢å¼•
            // ç§»åŠ¨å¹³å‡çº¿å’ŒæŠ€æœ¯æŒ‡æ ‡ä¹Ÿéœ€è¦å¤„ç†å•ä½é—®é¢˜ï¼ˆä½¿ç”¨ç›¸åŒçš„è½¬æ¢æ ‡å¿—ï¼‰
            const ma5 = validData.map(d => {
                let price = parseFloat(d.ma5) || 0;
                if (needConvert && price > 0) price = price / 100;
                return price;
            });
            const ma10 = validData.map(d => {
                let price = parseFloat(d.ma10) || 0;
                if (needConvert && price > 0) price = price / 100;
                return price;
            });
            const ma20 = validData.map(d => {
                let price = parseFloat(d.ma20) || 0;
                if (needConvert && price > 0) price = price / 100;
                return price;
            });
            const macd = validData.map(d => d.macd);
            const macdSignal = validData.map(d => d.macd_signal);
            const macdHist = validData.map(d => d.macd_hist);
            const rsi = validData.map(d => d.rsi);
            const bbUpper = validData.map(d => {
                let price = parseFloat(d.bb_upper) || 0;
                if (needConvert && price > 0) price = price / 100;
                return price;
            });
            const bbMiddle = validData.map(d => {
                let price = parseFloat(d.bb_middle) || 0;
                if (needConvert && price > 0) price = price / 100;
                return price;
            });
            const bbLower = validData.map(d => {
                let price = parseFloat(d.bb_lower) || 0;
                if (needConvert && price > 0) price = price / 100;
                return price;
            });
            const kdjK = validData.map(d => d.kdj_k);
            const kdjD = validData.map(d => d.kdj_d);
            const kdjJ = validData.map(d => d.kdj_j);
            
            // 1. Kçº¿å›¾ + ç§»åŠ¨å¹³å‡çº¿
            const klineTraces = [
                {
                    x: dates,
                    open: opens,
                    high: highs,
                    low: lows,
                    close: closes,
                    type: 'candlestick',
                    name: 'Kçº¿',
                    increasing: {line: {color: '#ef5350'}},
                    decreasing: {line: {color: '#26a69a'}}
                },
                {
                    x: dates,
                    y: ma5,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MA5',
                    line: {color: '#ff9800', width: 1.5}
                },
                {
                    x: dates,
                    y: ma10,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MA10',
                    line: {color: '#2196f3', width: 1.5}
                },
                {
                    x: dates,
                    y: ma20,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MA20',
                    line: {color: '#9c27b0', width: 1.5}
                }
            ];
            
            Plotly.newPlot('klineChart', klineTraces, {
                title: `${stockCode} Kçº¿å›¾ + ç§»åŠ¨å¹³å‡çº¿`,
                xaxis: {
                    title: 'æ—¥æœŸ', 
                    type: 'category',
                    tickformat: '',
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: Math.max(1, Math.floor(dates.length / 10))
                },
                yaxis: {title: 'ä»·æ ¼ï¼ˆå…ƒï¼‰'},
                hovermode: 'x unified',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            }, {responsive: true});
            
            // ç”ŸæˆAIåˆ†æ
            generateAIAnalysis('klineAnalysis', 'Kçº¿å›¾', stockCode, {
                dates: dates,
                closes: closes,
                ma5: ma5,
                ma10: ma10,
                ma20: ma20
            });
            
            // 2. MACDæŒ‡æ ‡å›¾
            const macdTraces = [
                {
                    x: dates,
                    y: macd,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MACD',
                    line: {color: '#2196f3', width: 2}
                },
                {
                    x: dates,
                    y: macdSignal,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Signal',
                    line: {color: '#ff9800', width: 2}
                },
                {
                    x: dates,
                    y: macdHist,
                    type: 'bar',
                    name: 'Histogram',
                    marker: {
                        color: macdHist.map(v => v >= 0 ? '#26a69a' : '#ef5350')
                    }
                }
            ];
            
            Plotly.newPlot('macdChart', macdTraces, {
                title: 'MACDæŒ‡æ ‡',
                xaxis: {
                    title: 'æ—¥æœŸ', 
                    type: 'category',
                    tickformat: '',
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: Math.max(1, Math.floor(dates.length / 10))
                },
                yaxis: {title: 'MACDå€¼'},
                hovermode: 'x unified',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            }, {responsive: true});
            
            generateAIAnalysis('macdAnalysis', 'MACDæŒ‡æ ‡', stockCode, {
                dates: dates,
                macd: macd,
                macdSignal: macdSignal,
                macdHist: macdHist
            });
            
            // 3. RSIæŒ‡æ ‡å›¾
            const rsiTraces = [
                {
                    x: dates,
                    y: rsi,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'RSI',
                    line: {color: '#9c27b0', width: 2},
                    fill: 'tozeroy',
                    fillcolor: 'rgba(156, 39, 176, 0.2)'
                },
                {
                    x: dates,
                    y: Array(dates.length).fill(70),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'è¶…ä¹°çº¿(70)',
                    line: {color: '#ef5350', width: 1, dash: 'dash'}
                },
                {
                    x: dates,
                    y: Array(dates.length).fill(30),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'è¶…å–çº¿(30)',
                    line: {color: '#26a69a', width: 1, dash: 'dash'}
                }
            ];
            
            Plotly.newPlot('rsiChart', rsiTraces, {
                title: 'RSIç›¸å¯¹å¼ºå¼±æŒ‡æ ‡',
                xaxis: {
                    title: 'æ—¥æœŸ', 
                    type: 'category',
                    tickformat: '',
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: Math.max(1, Math.floor(dates.length / 10))
                },
                yaxis: {title: 'RSIå€¼', range: [0, 100]},
                hovermode: 'x unified',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            }, {responsive: true});
            
            generateAIAnalysis('rsiAnalysis', 'RSIæŒ‡æ ‡', stockCode, {
                dates: dates,
                rsi: rsi
            });
            
            // 4. å¸ƒæ—å¸¦å›¾
            const bollingerTraces = [
                {
                    x: dates,
                    y: closes,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'æ”¶ç›˜ä»·',
                    line: {color: '#2196f3', width: 2}
                },
                {
                    x: dates,
                    y: bbUpper,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'ä¸Šè½¨',
                    line: {color: '#ef5350', width: 1.5, dash: 'dash'}
                },
                {
                    x: dates,
                    y: bbMiddle,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'ä¸­è½¨',
                    line: {color: '#ff9800', width: 1.5}
                },
                {
                    x: dates,
                    y: bbLower,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'ä¸‹è½¨',
                    line: {color: '#26a69a', width: 1.5, dash: 'dash'},
                    fill: 'tonexty',
                    fillcolor: 'rgba(38, 166, 154, 0.1)'
                }
            ];
            
            Plotly.newPlot('bollingerChart', bollingerTraces, {
                title: 'å¸ƒæ—å¸¦æŒ‡æ ‡',
                xaxis: {
                    title: 'æ—¥æœŸ', 
                    type: 'category',
                    tickformat: '',
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: Math.max(1, Math.floor(dates.length / 10))
                },
                yaxis: {title: 'ä»·æ ¼ï¼ˆå…ƒï¼‰'},
                hovermode: 'x unified',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            }, {responsive: true});
            
            generateAIAnalysis('bollingerAnalysis', 'å¸ƒæ—å¸¦æŒ‡æ ‡', stockCode, {
                dates: dates,
                closes: closes,
                bbUpper: bbUpper,
                bbMiddle: bbMiddle,
                bbLower: bbLower
            });
            
            // 5. KDJæŒ‡æ ‡å›¾
            const kdjTraces = [
                {
                    x: dates,
                    y: kdjK,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Kçº¿',
                    line: {color: '#2196f3', width: 2}
                },
                {
                    x: dates,
                    y: kdjD,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Dçº¿',
                    line: {color: '#ff9800', width: 2}
                },
                {
                    x: dates,
                    y: kdjJ,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Jçº¿',
                    line: {color: '#9c27b0', width: 2}
                },
                {
                    x: dates,
                    y: Array(dates.length).fill(80),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'è¶…ä¹°çº¿(80)',
                    line: {color: '#ef5350', width: 1, dash: 'dash'}
                },
                {
                    x: dates,
                    y: Array(dates.length).fill(20),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'è¶…å–çº¿(20)',
                    line: {color: '#26a69a', width: 1, dash: 'dash'}
                }
            ];
            
            Plotly.newPlot('kdjChart', kdjTraces, {
                title: 'KDJéšæœºæŒ‡æ ‡',
                xaxis: {
                    title: 'æ—¥æœŸ', 
                    type: 'category',
                    tickformat: '',
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: Math.max(1, Math.floor(dates.length / 10))
                },
                yaxis: {title: 'KDJå€¼', range: [0, 100]},
                hovermode: 'x unified',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            }, {responsive: true});
            
            generateAIAnalysis('kdjAnalysis', 'KDJæŒ‡æ ‡', stockCode, {
                dates: dates,
                kdjK: kdjK,
                kdjD: kdjD,
                kdjJ: kdjJ
            });
            
            // 6. æˆäº¤é‡å›¾
            const volumeTraces = [
                {
                    x: dates,
                    y: volumes,
                    type: 'bar',
                    name: 'æˆäº¤é‡',
                    marker: {
                        color: closes.map((c, i) => {
                            if (i === 0) return '#26a69a';
                            return c >= closes[i-1] ? '#26a69a' : '#ef5350';
                        })
                    }
                }
            ];
            
            Plotly.newPlot('volumeChart', volumeTraces, {
                title: 'æˆäº¤é‡',
                xaxis: {
                    title: 'æ—¥æœŸ', 
                    type: 'category',
                    tickformat: '',
                    tickmode: 'linear',
                    tick0: 0,
                    dtick: Math.max(1, Math.floor(dates.length / 10))
                },
                yaxis: {title: 'æˆäº¤é‡'},
                hovermode: 'x unified',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            }, {responsive: true});
            
            generateAIAnalysis('volumeAnalysis', 'æˆäº¤é‡', stockCode, {
                dates: dates,
                volumes: volumes,
                closes: closes
            });
        }
        
        // ç”ŸæˆAIåˆ†æ
        function generateAIAnalysis(elementId, chartType, stockCode, data) {
            const analysisDiv = document.getElementById(elementId);
            if (!analysisDiv) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            analysisDiv.className = 'ai-analysis loading';
            analysisDiv.innerHTML = '';
            
            // å‡†å¤‡åˆ†ææ•°æ®æ‘˜è¦
            const summary = prepareDataSummary(chartType, data);
            
            // è°ƒç”¨åç«¯APIè·å–AIåˆ†æ
            fetch('/api/ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chart_type: chartType,
                    stock_code: stockCode,
                    data_summary: summary
                })
            })
            .then(response => response.json())
            .then(result => {
                analysisDiv.className = 'ai-analysis';
                if (result.success && result.analysis) {
                    analysisDiv.innerHTML = `<span class="ai-analysis-label">ğŸ¤– AIåˆ†æï¼š</span><span class="ai-analysis-content">${result.analysis}</span>`;
                } else {
                    const errorMsg = result.analysis || 'åˆ†æç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    analysisDiv.innerHTML = `<span class="ai-analysis-label">ğŸ¤– AIåˆ†æï¼š</span><span class="ai-analysis-content">${errorMsg}</span>`;
                }
            })
            .catch(error => {
                analysisDiv.className = 'ai-analysis';
                analysisDiv.innerHTML = `<span class="ai-analysis-label">ğŸ¤– AIåˆ†æï¼š</span><span class="ai-analysis-content">æ— æ³•è¿æ¥åˆ°AIæœåŠ¡ï¼Œè¯·ç¡®ä¿Ollamaå·²å¯åŠ¨ã€‚</span>`;
                console.error('AIåˆ†æå¤±è´¥:', error);
            });
        }
        
        // å‡†å¤‡æ•°æ®æ‘˜è¦ç”¨äºAIåˆ†æ
        function prepareDataSummary(chartType, data) {
            const summary = { chart_type: chartType };
            
            try {
                if (chartType === 'Kçº¿å›¾') {
                    if (data.closes && data.closes.length > 0) {
                        const validCloses = data.closes.filter(v => v !== null && v !== undefined);
                        const validMa5 = data.ma5.filter(v => v !== null && v !== undefined);
                        const validMa10 = data.ma10.filter(v => v !== null && v !== undefined);
                        const validMa20 = data.ma20.filter(v => v !== null && v !== undefined);
                        
                        if (validCloses.length > 0) {
                            const lastClose = validCloses[validCloses.length - 1];
                            const prevClose = validCloses.length > 1 ? validCloses[validCloses.length - 2] : lastClose;
                            const change = prevClose > 0 ? ((lastClose - prevClose) / prevClose * 100).toFixed(2) : '0';
                            summary.current_price = lastClose.toFixed(2);
                            summary.price_change = change;
                        }
                        
                        if (validMa5.length > 1) {
                            summary.ma5_trend = validMa5[validMa5.length - 1] > validMa5[validMa5.length - 2] ? 'ä¸Šå‡' : 'ä¸‹é™';
                        }
                        if (validMa10.length > 1) {
                            summary.ma10_trend = validMa10[validMa10.length - 1] > validMa10[validMa10.length - 2] ? 'ä¸Šå‡' : 'ä¸‹é™';
                        }
                        if (validMa20.length > 1) {
                            summary.ma20_trend = validMa20[validMa20.length - 1] > validMa20[validMa20.length - 2] ? 'ä¸Šå‡' : 'ä¸‹é™';
                        }
                    }
                } else if (chartType === 'MACDæŒ‡æ ‡') {
                    const validMacd = data.macd.filter(v => v !== null && v !== undefined && !isNaN(v));
                    const validSignal = data.macdSignal.filter(v => v !== null && v !== undefined && !isNaN(v));
                    const validHist = data.macdHist.filter(v => v !== null && v !== undefined && !isNaN(v));
                    
                    if (validMacd.length > 0) {
                        const lastMacd = validMacd[validMacd.length - 1];
                        summary.macd_value = lastMacd.toFixed(4);
                    } else {
                        summary.macd_value = 'N/A';
                    }
                    if (validSignal.length > 0) {
                        const lastSignal = validSignal[validSignal.length - 1];
                        summary.signal_value = lastSignal.toFixed(4);
                    } else {
                        summary.signal_value = 'N/A';
                    }
                    if (validHist.length > 0) {
                        const lastHist = validHist[validHist.length - 1];
                        summary.histogram_value = lastHist.toFixed(4);
                    } else {
                        summary.histogram_value = 'N/A';
                    }
                    if (validMacd.length > 0 && validSignal.length > 0) {
                        const lastMacdVal = validMacd[validMacd.length - 1];
                        const lastSignalVal = validSignal[validSignal.length - 1];
                        summary.cross_signal = lastMacdVal > lastSignalVal ? 'MACDåœ¨ä¿¡å·çº¿ä¸Šæ–¹' : 'MACDåœ¨ä¿¡å·çº¿ä¸‹æ–¹';
                    } else {
                        summary.cross_signal = 'æ•°æ®ä¸è¶³';
                    }
                } else if (chartType === 'RSIæŒ‡æ ‡') {
                    const validRsi = data.rsi.filter(v => v !== null && v !== undefined);
                    if (validRsi.length > 0) {
                        const lastRsi = validRsi[validRsi.length - 1];
                        summary.rsi_value = lastRsi.toFixed(2);
                        if (lastRsi > 70) summary.signal = 'è¶…ä¹°';
                        else if (lastRsi < 30) summary.signal = 'è¶…å–';
                        else summary.signal = 'æ­£å¸¸';
                    }
                } else if (chartType === 'å¸ƒæ—å¸¦æŒ‡æ ‡') {
                    const validCloses = data.closes.filter(v => v !== null && v !== undefined);
                    const validUpper = data.bbUpper.filter(v => v !== null && v !== undefined);
                    const validLower = data.bbLower.filter(v => v !== null && v !== undefined);
                    
                    if (validCloses.length > 0 && validUpper.length > 0 && validLower.length > 0) {
                        const lastClose = validCloses[validCloses.length - 1];
                        const lastUpper = validUpper[validUpper.length - 1];
                        const lastLower = validLower[validLower.length - 1];
                        summary.current_price = lastClose.toFixed(2);
                        summary.upper_band = lastUpper.toFixed(2);
                        summary.lower_band = lastLower.toFixed(2);
                        if (lastClose > lastUpper) summary.position = 'çªç ´ä¸Šè½¨';
                        else if (lastClose < lastLower) summary.position = 'è·Œç ´ä¸‹è½¨';
                        else summary.position = 'åœ¨å¸ƒæ—å¸¦å†…';
                    }
                } else if (chartType === 'KDJæŒ‡æ ‡') {
                    const validK = data.kdjK.filter(v => v !== null && v !== undefined);
                    const validD = data.kdjD.filter(v => v !== null && v !== undefined);
                    const validJ = data.kdjJ.filter(v => v !== null && v !== undefined);
                    
                    if (validK.length > 0) {
                        summary.k_value = validK[validK.length - 1].toFixed(2);
                    }
                    if (validD.length > 0) {
                        summary.d_value = validD[validD.length - 1].toFixed(2);
                    }
                    if (validJ.length > 0) {
                        summary.j_value = validJ[validJ.length - 1].toFixed(2);
                    }
                    if (validK.length > 0 && validD.length > 0) {
                        summary.cross = validK[validK.length - 1] > validD[validD.length - 1] ? 'Kçº¿åœ¨Dçº¿ä¸Šæ–¹' : 'Kçº¿åœ¨Dçº¿ä¸‹æ–¹';
                    }
                } else if (chartType === 'æˆäº¤é‡') {
                    const validVolumes = data.volumes.filter(v => v !== null && v !== undefined && v > 0);
                    if (validVolumes.length > 0) {
                        const lastVolume = validVolumes[validVolumes.length - 1];
                        const recentVolumes = validVolumes.slice(-5);
                        const avgVolume = recentVolumes.reduce((a, b) => a + b, 0) / recentVolumes.length;
                        summary.current_volume = lastVolume.toFixed(0);
                        summary.avg_volume = avgVolume.toFixed(0);
                        summary.volume_ratio = avgVolume > 0 ? (lastVolume / avgVolume).toFixed(2) : '1.00';
                    }
                }
            } catch (e) {
                console.error('å‡†å¤‡æ•°æ®æ‘˜è¦å¤±è´¥:', e);
            }
            
            return summary;
        }
        
        function generateTechnicalAnalysis(stockData) {
            if (!stockData || stockData.length === 0) return;
            
            const last = stockData[stockData.length - 1];
            const prev = stockData[stockData.length - 2] || last;
            
            let analysis = [];
            
            // MACDåˆ†æ
            if (last.macd !== null && last.macd_signal !== null) {
                if (last.macd > last.macd_signal && prev.macd <= prev.macd_signal) {
                    analysis.push({indicator: 'MACD', signal: 'ä¹°å…¥', description: 'MACDé‡‘å‰ï¼ŒçŸ­æœŸçœ‹æ¶¨ä¿¡å·'});
                } else if (last.macd < last.macd_signal && prev.macd >= prev.macd_signal) {
                    analysis.push({indicator: 'MACD', signal: 'å–å‡º', description: 'MACDæ­»å‰ï¼ŒçŸ­æœŸçœ‹è·Œä¿¡å·'});
                } else if (last.macd > last.macd_signal) {
                    analysis.push({indicator: 'MACD', signal: 'æŒæœ‰', description: 'MACDåœ¨ä¿¡å·çº¿ä¸Šæ–¹ï¼Œè¶‹åŠ¿å‘ä¸Š'});
                } else {
                    analysis.push({indicator: 'MACD', signal: 'è°¨æ…', description: 'MACDåœ¨ä¿¡å·çº¿ä¸‹æ–¹ï¼Œè¶‹åŠ¿å‘ä¸‹'});
                }
            }
            
            // RSIåˆ†æ
            if (last.rsi !== null) {
                if (last.rsi > 70) {
                    analysis.push({indicator: 'RSI', signal: 'å–å‡º', description: `RSI=${last.rsi.toFixed(2)}ï¼Œå¤„äºè¶…ä¹°åŒºåŸŸï¼Œå¯èƒ½å›è°ƒ`});
                } else if (last.rsi < 30) {
                    analysis.push({indicator: 'RSI', signal: 'ä¹°å…¥', description: `RSI=${last.rsi.toFixed(2)}ï¼Œå¤„äºè¶…å–åŒºåŸŸï¼Œå¯èƒ½åå¼¹`});
                } else {
                    analysis.push({indicator: 'RSI', signal: 'ä¸­æ€§', description: `RSI=${last.rsi.toFixed(2)}ï¼Œå¤„äºæ­£å¸¸åŒºé—´`});
                }
            }
            
            // å¸ƒæ—å¸¦åˆ†æ
            if (last.close !== null && last.bb_upper !== null && last.bb_lower !== null) {
                if (last.close > last.bb_upper) {
                    analysis.push({indicator: 'å¸ƒæ—å¸¦', signal: 'å–å‡º', description: 'ä»·æ ¼çªç ´ä¸Šè½¨ï¼Œå¯èƒ½å›è°ƒ'});
                } else if (last.close < last.bb_lower) {
                    analysis.push({indicator: 'å¸ƒæ—å¸¦', signal: 'ä¹°å…¥', description: 'ä»·æ ¼è·Œç ´ä¸‹è½¨ï¼Œå¯èƒ½åå¼¹'});
                } else {
                    analysis.push({indicator: 'å¸ƒæ—å¸¦', signal: 'æŒæœ‰', description: 'ä»·æ ¼åœ¨å¸ƒæ—å¸¦å†…è¿è¡Œï¼Œè¶‹åŠ¿æ­£å¸¸'});
                }
            }
            
            // KDJåˆ†æ
            if (last.kdj_k !== null && last.kdj_d !== null) {
                if (last.kdj_k > last.kdj_d && prev.kdj_k <= prev.kdj_d) {
                    analysis.push({indicator: 'KDJ', signal: 'ä¹°å…¥', description: 'KDJé‡‘å‰ï¼ŒçŸ­æœŸçœ‹æ¶¨'});
                } else if (last.kdj_k < last.kdj_d && prev.kdj_k >= prev.kdj_d) {
                    analysis.push({indicator: 'KDJ', signal: 'å–å‡º', description: 'KDJæ­»å‰ï¼ŒçŸ­æœŸçœ‹è·Œ'});
                } else if (last.kdj_k > 80) {
                    analysis.push({indicator: 'KDJ', signal: 'å–å‡º', description: 'KDJè¶…ä¹°ï¼Œå¯èƒ½å›è°ƒ'});
                } else if (last.kdj_k < 20) {
                    analysis.push({indicator: 'KDJ', signal: 'ä¹°å…¥', description: 'KDJè¶…å–ï¼Œå¯èƒ½åå¼¹'});
                }
            }
            
            // ç§»åŠ¨å¹³å‡çº¿åˆ†æ
            if (last.ma5 !== null && last.ma10 !== null && last.ma20 !== null && last.close !== null) {
                if (last.close > last.ma5 && last.ma5 > last.ma10 && last.ma10 > last.ma20) {
                    analysis.push({indicator: 'å‡çº¿', signal: 'ä¹°å…¥', description: 'å¤šå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸Š'});
                } else if (last.close < last.ma5 && last.ma5 < last.ma10 && last.ma10 < last.ma20) {
                    analysis.push({indicator: 'å‡çº¿', signal: 'å–å‡º', description: 'ç©ºå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸‹'});
                }
            }
            
            // æ˜¾ç¤ºåˆ†æç»“æœ
            const analysisDiv = document.getElementById('technicalAnalysis');
            if (analysis.length > 0) {
                let html = '<div class="technical-analysis-card"><h6>ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡ç»¼åˆåˆ†æ</h6>';
                analysis.forEach(item => {
                    const signalColor = item.signal === 'ä¹°å…¥' ? '#26a69a' : 
                                      item.signal === 'å–å‡º' ? '#ef5350' : '#ff9800';
                    html += `
                        <div class="analysis-item">
                            <strong>${item.indicator}</strong> - 
                            <span style="color: ${signalColor}; font-weight: bold;">${item.signal}</span>ï¼š
                            ${item.description}
                        </div>
                    `;
                });
                html += '</div>';
                analysisDiv.innerHTML = html;
            }
        }
        
        function drawPredictionChart(prediction) {
            const dates = prediction.prediction_dates || [];
            const prices = prediction.predictions || [];
            const currentPrice = prediction.current_price || 0;

            // æ·»åŠ å½“å‰ä»·æ ¼ä½œä¸ºèµ·ç‚¹ï¼Œæ ¼å¼åŒ–æ—¥æœŸä¸ºç®€æ´å½¢å¼
            const today = formatDateSimple(new Date());
            const formattedDates = dates.map(d => formatDateSimple(d));
            const allDates = [today, ...formattedDates];
            const allPrices = [currentPrice, ...prices];

            const trace = {
                x: allDates,
                y: allPrices,
                mode: 'lines+markers',
                name: 'é¢„æµ‹ä»·æ ¼',
                line: { color: '#007bff', width: 3 },
                marker: { size: 10, color: '#007bff' },
                fill: 'tozeroy',
                fillcolor: 'rgba(0, 123, 255, 0.2)'
            };

            const layout = {
                title: 'ä»·æ ¼é¢„æµ‹è¶‹åŠ¿',
                xaxis: { title: 'æ—¥æœŸ' },
                yaxis: { title: 'ä»·æ ¼ï¼ˆå…ƒï¼‰' },
                hovermode: 'closest',
                template: 'plotly_dark',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'}
            };

            Plotly.newPlot('predictionChart', [trace], layout, {responsive: true});
        }

        // ç”Ÿæˆ"è‚¡ç¥¨æ•°æ®é‡åŒ–åˆ†æ"Tabçš„å†…å®¹
        function generateQuantitativeAnalysisHTML(data, decision, prediction, visualization) {
            // ç¡®ä¿å‚æ•°ä¸ä¸ºç©º
            data = data || {};
            decision = decision || {};
            prediction = prediction || {};
            visualization = visualization || {};
            
            let html = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>ğŸ¯ å†³ç­–å»ºè®®</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>æ“ä½œï¼š</strong> 
                                    <span class="badge bg-${decision.action === 'ä¹°å…¥' ? 'success' : decision.action === 'å–å‡º' ? 'danger' : 'secondary'}">
                                        ${decision.action || 'æœªçŸ¥'}
                                    </span>
                                </p>
                                <p><strong>å½“å‰ä»·æ ¼ï¼š</strong> ï¿¥${decision.current_price?.toFixed(2) || 'N/A'}</p>
                                ${decision.suggested_shares ? `
                                    <p><strong>å»ºè®®æ•°é‡ï¼š</strong> ${decision.suggested_shares}è‚¡</p>
                                    <p><strong>å»ºè®®é‡‘é¢ï¼š</strong> ï¿¥${decision.suggested_amount?.toFixed(2) || 'N/A'}</p>
                                ` : ''}
                                <p><strong>å»ºè®®ç†ç”±ï¼š</strong> ${decision.suggestion || 'æ— '}</p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>ğŸ“ˆ é¢„æµ‹ç»“æœ</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>é¢„æµ‹è¶‹åŠ¿ï¼š</strong> ${prediction.trend || 'æœªçŸ¥'}</p>
                                <p><strong>é¢„æœŸæ”¶ç›Šç‡ï¼š</strong> 
                                    <span style="color: ${prediction.predicted_return_pct > 0 ? 'red' : 'green'}">
                                        ${prediction.predicted_return_pct?.toFixed(2) || 0}%
                                    </span>
                                </p>
                                <p><strong>ç½®ä¿¡åº¦ï¼š</strong> ${(prediction.confidence * 100)?.toFixed(1) || 0}%</p>
                                <p><strong>é£é™©ç­‰çº§ï¼š</strong> 
                                    <span class="badge bg-${prediction.risk_level === 'ä½' ? 'success' : prediction.risk_level === 'ä¸­' ? 'warning' : 'danger'}">
                                        ${prediction.risk_level || 'æœªçŸ¥'}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>âš™ï¸ è§„åˆ™è¯„ä¼°</h6>
                            </div>
                            <div class="card-body">
                                ${visualization.steps && visualization.steps.length > 0 ? `
                                    <div class="rules-list-container mb-3">
                                        <strong class="d-block mb-2">æ‰€æœ‰è§„åˆ™åˆ—è¡¨ï¼ˆåŒ¹é…çš„è§„åˆ™ç”¨ç»¿è‰²âˆšæ ‡è®°ï¼‰ï¼š</strong>
                                        ${visualization.steps.map(step => `
                                            <div class="rule-bar-item ${step.is_triggered ? 'rule-triggered' : ''}">
                                                <div class="rule-bar-header">
                                                    <span class="rule-id-badge">${step.rule_id || ''}</span>
                                                    <strong class="rule-name">${step.rule_name || ''}</strong>
                                                    <span class="rule-type-badge">${step.rule_type || ''}</span>
                                                    ${step.is_triggered ? '<span class="rule-match-mark">âœ“</span>' : ''}
                                                </div>
                                                <div class="rule-bar-body">
                                                    <p class="rule-description mb-1">${step.description || ''}</p>
                                                    ${step.action && step.action.message ? `
                                                        <p class="rule-action mb-0">
                                                            <span class="action-type">${step.action.type || ''}ï¼š</span>
                                                            <span class="action-message">${step.action.message || ''}</span>
                                                        </p>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div class="alert alert-info mb-3">æœªæ‰¾åˆ°ä»»ä½•è§„åˆ™</div>'}
                                <div class="rule-summary">
                                    <p><strong>è§¦å‘è§„åˆ™æ•°ï¼š</strong> ${visualization.triggered_rules || 0} / ${visualization.total_rules || 0}</p>
                                    <p><strong>è¯„ä¼°ç»“æœï¼š</strong> 
                                        <span class="badge bg-${visualization.is_allowed ? 'success' : 'danger'}">
                                            ${visualization.is_allowed ? 'å…è®¸' : 'ç¦æ­¢'}
                                        </span>
                                    </p>
                                    ${!visualization.is_allowed && visualization.reason ? `
                                        <p class="text-danger mt-2"><strong>åŸå› ï¼š</strong> ${visualization.reason}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // æ·»åŠ æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨åŒºåŸŸ
            if (data.stock_data && data.stock_data.length > 0) {
                html += `
                    <div class="card mt-3">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">ğŸ“Š æŠ€æœ¯æŒ‡æ ‡ï¼ˆé‡åŒ–æŒ‡æ ‡ï¼‰<span id="dataSourceBadge" class="badge ms-2" style="font-size: 0.7em;"></span></h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <div class="chart-wrapper">
                                    <div id="klineChart" class="chart-box"></div>
                                    <div id="klineAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="macdChart" class="chart-box"></div>
                                    <div id="macdAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="rsiChart" class="chart-box"></div>
                                    <div id="rsiAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="bollingerChart" class="chart-box"></div>
                                    <div id="bollingerAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="kdjChart" class="chart-box"></div>
                                    <div id="kdjAnalysis" class="ai-analysis"></div>
                                </div>
                                <div class="chart-wrapper">
                                    <div id="volumeChart" class="chart-box"></div>
                                    <div id="volumeAnalysis" class="ai-analysis"></div>
                                </div>
                            </div>
                            <div id="technicalAnalysis" class="mt-3"></div>
                        </div>
                    </div>
                `;
            }
            
            // ç§»é™¤ä»·æ ¼é¢„æµ‹è¶‹åŠ¿å›¾è¡¨ï¼ˆç”¨æˆ·è¦æ±‚åˆ é™¤ï¼‰
            
            // æ·»åŠ å†³ç­–è§£é‡Š
            html += `
                <div class="card mt-3">
                    <div class="card-header">
                        <h6>ğŸ’¡ å†³ç­–è§£é‡Š</h6>
                    </div>
                    <div class="card-body">
                        <div id="decisionExplanation">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                                <p class="mt-2">æ­£åœ¨ç”Ÿæˆå†³ç­–è§£é‡Š...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('[generateQuantitativeAnalysisHTML] æœ€ç»ˆHTMLé•¿åº¦:', html.length);
            return html;
        }
        
        // ç”Ÿæˆ"è‚¡ä»·é¢„æµ‹"Tabçš„å†…å®¹
        function generatePredictionHTML(multiModelData, stockCode) {
            // å³ä½¿æ²¡æœ‰é¢„æµ‹æ•°æ®ï¼Œä¹Ÿè¦æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆåªè¦æœ‰multiModelDataå¯¹è±¡ï¼‰
            // åªæœ‰åœ¨å®Œå…¨æ²¡æœ‰multiModelDataæ—¶æ‰æ˜¾ç¤ºåŠ è½½æç¤º
            if (!multiModelData) {
                return `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">æ­£åœ¨è·å–æ¨¡å‹é¢„æµ‹æ•°æ®...</p>
                        <p class="text-muted small">å¦‚æœé•¿æ—¶é—´æœªå“åº”ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                    </div>
                `;
            }
            
            const predictions = multiModelData?.predictions || {};
            const modelInfo = multiModelData?.model_info || {};
            const trainingResults = multiModelData?.training_results || {};
            const trainingStatus = multiModelData?.training_status || {};
            const progressId = multiModelData?.progress_id;  // è·å–è¿›åº¦ID
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è®­ç»ƒç»“æœ
            const trainedModels = Object.keys(trainingResults).filter(k => {
                const result = trainingResults[k];
                return result && typeof result === 'object' && !result.error && 
                       (result.train_mae !== undefined || result.val_mae !== undefined);
            });
            const hasTraining = trainingStatus.has_training || trainedModels.length > 0;
            const trainingProgress = trainingStatus.training_progress || 0;
            
            // å¦‚æœæœ‰è¿›åº¦IDï¼Œå¯åŠ¨è½®è¯¢
            if (progressId && !hasTraining) {
                startTrainingProgressPolling(progressId);
            } else if (hasTraining && Object.keys(predictions).length > 0) {
                // å¦‚æœè®­ç»ƒå·²ç»å®Œæˆä¸”æœ‰é¢„æµ‹ç»“æœï¼Œå¯åŠ¨è¿›åº¦æ¡æ¨¡æ‹Ÿï¼Œè®©è¿›åº¦æ¡ä»0%å¢é•¿åˆ°100%
                console.log('[generatePredictionHTML] è®­ç»ƒå·²å®Œæˆï¼Œå¯åŠ¨è¿›åº¦æ¡æ¨¡æ‹Ÿ');
                // å»¶è¿Ÿä¸€ç‚¹å¯åŠ¨ï¼Œç¡®ä¿DOMå·²ç»æ¸²æŸ“
                setTimeout(() => {
                    startProgressSimulation();
                }, 100);
            }
            
            let html = `
                <!-- è®­ç»ƒ-é¢„æµ‹æ¨¡å‹æ­¥éª¤å›¾ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰ -->
                <div class="card mb-3">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0">ğŸ”„ è®­ç»ƒ-é¢„æµ‹æ¨¡å‹</h5>
                    </div>
                    <div class="card-body">
                        <!-- æ¨¡å‹è®­ç»ƒçŠ¶æ€åˆ—è¡¨ -->
                        <div id="trainingModelList">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>æ¨¡å‹è®­ç»ƒè¿›åº¦ï¼š</h6>
                                    <div class="list-group">
                                        ${(() => {
                                            const modelNames = [
                                                { key: 'random_forest', name: 'éšæœºæ£®æ—å›å½’' },
                                                { key: 'gradient_boosting', name: 'æ¢¯åº¦æå‡å›å½’' },
                                                { key: 'linear_regression', name: 'çº¿æ€§å›å½’' },
                                                { key: 'ridge', name: 'Ridgeå›å½’' },
                                                { key: 'lasso', name: 'Lassoå›å½’' },
                                                { key: 'xgboost', name: 'XGBoost' },
                                                { key: 'lightgbm', name: 'LightGBM' }
                                            ];
                                            let html = '';
                                            modelNames.forEach(model => {
                                                const modelResult = trainingResults[model.key];
                                                const isCompleted = modelResult && !modelResult.error && 
                                                                   (modelResult.train_mae !== undefined || modelResult.val_mae !== undefined);
                                                const statusIcon = isCompleted ? 'âœ…' : 'â¸ï¸';
                                                const statusClass = isCompleted ? 'list-group-item-success' : 'list-group-item-secondary';
                                                const badgeClass = isCompleted ? 'bg-success' : 'bg-warning';
                                                const badgeText = isCompleted ? 'å·²å®Œæˆ' : 'ç­‰å¾…ä¸­';
                                                const progressBarClass = isCompleted ? 'bg-success' : 'bg-warning progress-bar-animated';
                                                const progressWidth = isCompleted ? '100' : '0';
                                                
                                                // å®‰å…¨åœ°è·å–val_r2å€¼
                                                const valR2 = modelResult && modelResult.val_r2;
                                                const valR2Display = (valR2 !== null && valR2 !== undefined && !isNaN(valR2)) 
                                                    ? `<br><small class="text-muted">RÂ²: ${Number(valR2).toFixed(4)}</small>` 
                                                    : '';
                                                
                                                html += `
                                                    <div class="list-group-item ${statusClass}" id="model-item-${model.key}">
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <div><strong>${statusIcon} ${model.name}</strong><div id="model-message-${model.key}">${isCompleted ? valR2Display : ''}</div></div>
                                                        </div>
                                                        <div class="progress" style="height: 20px;" id="model-progress-${model.key}">
                                                            <div class="progress-bar progress-bar-striped ${progressBarClass}" style="width: ${progressWidth}%">${progressWidth >= 100 ? 'âœ… å·²å®Œæˆ' : 'â³ è®­ç»ƒä¸­...'}</div>
                                                        </div>
                                                    </div>
                                                `;
                                            });
                                            return html;
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¯¦ç»†æ­¥éª¤ -->
                        <div class="process-flow">
                            <div class="process-step completed">
                                <div class="step-icon">ğŸ“Š</div>
                                <div class="step-content">
                                    <h6>æ­¥éª¤ 1: æ•°æ®è·å–</h6>
                                    <p class="mb-0">ä»ç½‘ç»œè·å–è‚¡ç¥¨å†å²æ•°æ®${trainingStatus.data_days ? `ï¼ˆ${trainingStatus.data_days}å¤©ï¼‰` : ''}</p>
                                    <small class="text-muted">âœ… å·²å®Œæˆ</small>
                                </div>
                            </div>
                            <div class="step-arrow">â†’</div>
                            <div class="process-step completed">
                                <div class="step-icon">âš™ï¸</div>
                                <div class="step-content">
                                    <h6>æ­¥éª¤ 2: ç‰¹å¾å·¥ç¨‹</h6>
                                    <p class="mb-0">æå–ä»·æ ¼ç‰¹å¾ã€æŠ€æœ¯æŒ‡æ ‡ã€æˆäº¤é‡ç‰¹å¾</p>
                                    <small class="text-muted">âœ… å·²å®Œæˆ</small>
                                </div>
                            </div>
                            <div class="step-arrow">â†’</div>
                            <div class="process-step ${hasTraining ? 'completed' : 'pending'}">
                                <div class="step-icon">ğŸ¤–</div>
                                <div class="step-content">
                                    <h6>æ­¥éª¤ 3: æ¨¡å‹è®­ç»ƒ</h6>
                                    <p class="mb-0">è®­ç»ƒ ${modelInfo.model_count || Object.keys(predictions).length || 7} ä¸ªæœºå™¨å­¦ä¹ æ¨¡å‹</p>
                                    ${hasTraining ? `
                                        <div class="progress mt-2" style="height: 12px;" id="trainingProgressStep3">
                                            <div class="progress-bar bg-success progress-bar-striped" role="progressbar" 
                                                 style="width: ${trainingProgress}%" 
                                                 aria-valuenow="${trainingProgress}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                ${trainingProgress}%
                                            </div>
                                        </div>
                                        <small class="text-muted">âœ… å·²è®­ç»ƒ ${trainedModels.length}/${modelInfo.model_count || Object.keys(predictions).length || 7} ä¸ªæ¨¡å‹</small>
                                        ${trainingStatus.data_days ? `
                                            <small class="text-muted d-block mt-1">
                                                æ•°æ®é‡ï¼š${trainingStatus.data_days}å¤© 
                                                ${trainingStatus.data_days < trainingStatus.min_recommended ? 
                                                    `ï¼ˆæ¨èè‡³å°‘${trainingStatus.min_recommended}å¤©ä»¥è·å¾—æ›´å¥½æ•ˆæœï¼‰` : 
                                                    'ï¼ˆæ•°æ®é‡å……è¶³ï¼‰'}
                                            </small>
                                        ` : ''}
                                    ` : `
                                        <div class="progress mt-2" style="height: 12px;" id="trainingProgressStep3">
                                            <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" 
                                                 style="width: 0%" 
                                                 aria-valuenow="0" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                ç­‰å¾…è®­ç»ƒ...
                                            </div>
                                        </div>
                                        <small class="text-muted d-block">
                                            ğŸ’¡ ç‚¹å‡»"è‚¡ä»·é¢„æµ‹"Tabå¼€å§‹è®­ç»ƒæ¨¡å‹
                                            ${trainingStatus.data_days !== undefined ? `
                                                <br>å½“å‰æ•°æ®ï¼š${trainingStatus.data_days}å¤©ï¼Œéœ€è¦è‡³å°‘${trainingStatus.min_required || 68}å¤©
                                            ` : ''}
                                        </small>
                                    `}
                                </div>
                            </div>
                            <div class="step-arrow">â†’</div>
                            <div class="process-step completed">
                                <div class="step-icon">ğŸ“ˆ</div>
                                <div class="step-content">
                                    <h6>æ­¥éª¤ 4: æ¨¡å‹é¢„æµ‹</h6>
                                    <p class="mb-0">ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹é¢„æµ‹æœªæ¥ä»·æ ¼</p>
                                    <small class="text-muted">âœ… å·²å®Œæˆ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- å¤šæ¨¡å‹é¢„æµ‹ç»“æœ - ç›´æ¥æ˜¾ç¤ºåœ¨è®­ç»ƒæ­¥éª¤æ¡ä¸‹æ–¹ï¼ˆåˆå§‹éšè—ï¼Œç­‰è¿›åº¦æ¡å…¨éƒ¨å®Œæˆåå†æ˜¾ç¤ºï¼‰ -->
                <div class="prediction-results-container" style="display: none;">
                ${(() => {
                    const modelNames = Object.keys(predictions);
                    const modelColors = {
                        'random_forest': '#28a745',
                        'gradient_boosting': '#17a2b8',
                        'linear_regression': '#ffc107',
                        'ridge': '#fd7e14',
                        'lasso': '#e83e8c',
                        'xgboost': '#6f42c1',
                        'lightgbm': '#20c997'
                    };
                    
                    if (modelNames.length === 0) {
                        return `
                            <div class="alert alert-info mt-3">
                                <h6>â³ é¢„æµ‹ç»“æœç”Ÿæˆä¸­...</h6>
                                <p class="mb-0">æ¨¡å‹è®­ç»ƒå·²å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆé¢„æµ‹ç»“æœï¼Œè¯·ç¨å€™ã€‚</p>
                            </div>
                        `;
                    }
                    
                    let resultsHTML = `
                        <div class="card mt-3">
                            <div class="card-header bg-gradient-primary text-white">
                                <h5 class="mb-0">ğŸ¤– å¤šæ¨¡å‹é¢„æµ‹ç»“æœ - ${stockCode}</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>å¯ç”¨æ¨¡å‹æ•°é‡ï¼š</strong> ${modelInfo.model_count || modelNames.length}</p>
                                <p class="mb-2"><strong>XGBoostï¼š</strong> ${modelInfo.xgboost_available ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>
                                <p class="mb-0"><strong>LightGBMï¼š</strong> ${modelInfo.lightgbm_available ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>
                            </div>
                        </div>
                    `;
                    
                    // ä¸ºæ¯ä¸ªæ¨¡å‹åˆ›å»ºå¡ç‰‡
                    modelNames.forEach(modelName => {
                        const prediction = predictions[modelName];
                        const color = modelColors[modelName] || '#007bff';
                        const modelNameCn = prediction.model_name_cn || modelName;
                        const isTrained = !prediction.is_simple_prediction;
                        
                        resultsHTML += `
                            <div class="row mb-3 mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header" style="background-color: ${color}; color: white;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">${modelNameCn}</h6>
                                                ${isTrained ? 
                                                    '<span class="badge bg-success">å·²è®­ç»ƒ</span>' : 
                                                    '<span class="badge bg-warning">ç®€å•é¢„æµ‹</span>'}
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-3">
                                                    <small><strong>é¢„æœŸæ”¶ç›Šç‡ï¼š</strong></small>
                                                    <p class="mb-0" style="color: ${prediction.predicted_return_pct > 0 ? 'red' : 'green'}; font-size: 1.2em; font-weight: bold;">
                                                        ${prediction.predicted_return_pct?.toFixed(2) || 0}%
                                                    </p>
                                                </div>
                                                <div class="col-md-3">
                                                    <small><strong>ç½®ä¿¡åº¦ï¼š</strong></small>
                                                    <p class="mb-0" style="font-size: 1.2em; font-weight: bold;">
                                                        ${(prediction.confidence * 100)?.toFixed(1) || 0}%
                                                    </p>
                                                </div>
                                                <div class="col-md-3">
                                                    <small><strong>è¶‹åŠ¿ï¼š</strong></small>
                                                    <p class="mb-0">
                                                        <span style="color: ${prediction.trend === 'ä¸Šæ¶¨' ? 'red' : 'green'}; font-weight: bold;">
                                                            ${prediction.trend || 'æœªçŸ¥'}
                                                        </span>
                                                    </p>
                                                </div>
                                                <div class="col-md-3">
                                                    <small><strong>é£é™©ç­‰çº§ï¼š</strong></small>
                                                    <p class="mb-0">
                                                        <span class="badge bg-${prediction.risk_level === 'ä½' ? 'success' : prediction.risk_level === 'ä¸­' ? 'warning' : 'danger'}">
                                                            ${prediction.risk_level || 'æœªçŸ¥'}
                                                        </span>
                                                    </p>
                                                </div>
                                            </div>
                                            <div id="predictionChart_${modelName}" style="height: 350px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    return resultsHTML;
                })()}
                </div>
            `;
            
            // å¦‚æœæœ‰é¢„æµ‹ç»“æœï¼Œåœ¨è¿”å›HTMLåç»˜åˆ¶å›¾è¡¨
            // æ³¨æ„ï¼šå›¾è¡¨ç»˜åˆ¶ä¼šåœ¨è¿›åº¦æ¡å®Œæˆåè‡ªåŠ¨è§¦å‘ï¼ˆé€šè¿‡è¿›åº¦æ¨¡æ‹Ÿç³»ç»Ÿçš„å›è°ƒï¼‰
            const modelNames = Object.keys(predictions);
            if (modelNames.length > 0) {
                // å°†å›¾è¡¨ç»˜åˆ¶å‡½æ•°ä¿å­˜åˆ°å…¨å±€ï¼Œç­‰è¿›åº¦æ¡å®Œæˆåå†è°ƒç”¨
                window.drawPredictionCharts = function() {
                    console.log('[generatePredictionHTML] å¼€å§‹ç»˜åˆ¶é¢„æµ‹å›¾è¡¨');
                    const modelColors = {
                        'random_forest': '#28a745',
                        'gradient_boosting': '#17a2b8',
                        'linear_regression': '#ffc107',
                        'ridge': '#fd7e14',
                        'lasso': '#e83e8c',
                        'xgboost': '#6f42c1',
                        'lightgbm': '#20c997'
                    };
                    
                    modelNames.forEach((modelName, index) => {
                        setTimeout(() => {
                            const prediction = predictions[modelName];
                            const chartId = `predictionChart_${modelName}`;
                            const chartElement = document.getElementById(chartId);
                            
                            if (chartElement && prediction && prediction.predictions && prediction.predictions.length > 0 && 
                                prediction.prediction_dates && prediction.prediction_dates.length > 0) {
                                try {
                                    drawSingleModelChart(prediction, chartId, modelColors[modelName] || '#007bff');
                                    console.log(`[generatePredictionHTML] âœ… æ¨¡å‹ ${modelName} å›¾è¡¨ç»˜åˆ¶æˆåŠŸ`);
                                } catch (error) {
                                    console.error(`[generatePredictionHTML] âŒ æ¨¡å‹ ${modelName} å›¾è¡¨ç»˜åˆ¶å¤±è´¥:`, error);
                                }
                            } else {
                                console.warn(`[generatePredictionHTML] âš ï¸ æ¨¡å‹ ${modelName} æ•°æ®ä¸å®Œæ•´æˆ–å®¹å™¨ä¸å­˜åœ¨`);
                            }
                        }, index * 200); // æ¯ä¸ªæ¨¡å‹é—´éš”200ms
                    });
                };
            }
            
            return html;
        }
        
        // å¼€å§‹æ¨¡å‹è®­ç»ƒï¼ˆç‚¹å‡»Tabæ—¶è§¦å‘ï¼‰
        function startModelTraining(stockCode) {
            console.log('[æ¨¡å‹è®­ç»ƒ] å¼€å§‹è®­ç»ƒæ¨¡å‹ï¼Œè‚¡ç¥¨ä»£ç :', stockCode);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const predictionPanel = document.getElementById('prediction-panel');
            if (predictionPanel) {
                predictionPanel.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3 text-muted">æ­£åœ¨å¯åŠ¨æ¨¡å‹è®­ç»ƒ...</p>
                    </div>
                `;
            }
            
            // è°ƒç”¨è®­ç»ƒAPI
            fetch('/api/multi-model-predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ stock_code: stockCode })
            })
            .then(response => {
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    // å¦‚æœå“åº”ä¸æˆåŠŸï¼Œå°è¯•è§£æé”™è¯¯ä¿¡æ¯
                    return response.json().then(errData => {
                        throw new Error(errData.message || `æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
                    }).catch(() => {
                        throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(predictData => {
                console.log('[startModelTraining] æ”¶åˆ°å“åº”:', {
                    success: predictData.success,
                    hasPredictions: !!(predictData.predictions && Object.keys(predictData.predictions || {}).length > 0),
                    hasTrainingStatus: !!predictData.training_status,
                    progressId: predictData.progress_id,
                    message: predictData.message
                });
                
                // åªè¦successä¸ºtrueï¼Œå°±æ˜¾ç¤ºç•Œé¢ï¼ˆå³ä½¿predictionsä¸ºç©ºï¼Œä¹Ÿåº”è¯¥æ˜¾ç¤ºè¿›åº¦æ¡ï¼‰
                if (predictData.success) {
                    // æ›´æ–°é¢„æµ‹Tabçš„å†…å®¹
                    if (predictionPanel) {
                        predictionPanel.innerHTML = generatePredictionHTML({
                            predictions: predictData.predictions || {},
                            training_results: predictData.training_results || {},
                            model_info: predictData.model_info || {},
                            training_status: predictData.training_status || {},
                            progress_id: predictData.progress_id
                        }, stockCode);
                        
                        // ä¿å­˜è‚¡ç¥¨ä»£ç åˆ°å…¨å±€å˜é‡ï¼Œä¾›è®­ç»ƒå®Œæˆåä½¿ç”¨
                        window.currentStockCode = stockCode;
                        
                        // å¦‚æœæœ‰è¿›åº¦IDï¼Œå¯åŠ¨è½®è¯¢ï¼ˆè®­ç»ƒå®Œæˆåä¼šè‡ªåŠ¨æ˜¾ç¤ºç»“æœï¼‰
                        if (predictData.progress_id) {
                            console.log('[startModelTraining] å¯åŠ¨è¿›åº¦è½®è¯¢ï¼Œprogress_id:', predictData.progress_id);
                            startTrainingProgressPolling(predictData.progress_id);
                        } else if (predictData.training_status && predictData.training_status.has_training) {
                            // å¦‚æœè®­ç»ƒå·²ç»å®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é¢„æµ‹ç»“æœ
                            const hasPredictions = predictData.predictions && Object.keys(predictData.predictions).length > 0;
                            if (hasPredictions) {
                                // å¦‚æœè®­ç»ƒå·²å®Œæˆä¸”æœ‰é¢„æµ‹ç»“æœï¼Œç«‹å³æ˜¾ç¤ºç»“æœ
                                console.log('[startModelTraining] è®­ç»ƒå·²å®Œæˆï¼Œç«‹å³æ˜¾ç¤ºç»“æœ');
                                displayMultiModelResults({
                                    predictions: predictData.predictions || {},
                                    training_results: predictData.training_results || {},
                                    model_info: predictData.model_info || {},
                                    training_status: predictData.training_status || {},
                                    stock_code: stockCode
                                });
                            } else {
                                // å¦‚æœè®­ç»ƒå·²å®Œæˆä½†æ²¡æœ‰é¢„æµ‹ç»“æœï¼Œç­‰å¾…ä¸€ä¸‹å†é‡æ–°è·å–
                                console.log('[startModelTraining] è®­ç»ƒå·²å®Œæˆä½†æ²¡æœ‰é¢„æµ‹ç»“æœï¼Œç­‰å¾…2ç§’åé‡æ–°è·å–');
                                setTimeout(() => {
                                    fetch('/api/multi-model-predict', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ stock_code: stockCode })
                                    })
                                    .then(response => response.json())
                                    .then(predictData2 => {
                                        if (predictData2.success && predictData2.predictions && Object.keys(predictData2.predictions).length > 0) {
                                            displayMultiModelResults({
                                                predictions: predictData2.predictions,
                                                training_results: predictData2.training_results || {},
                                                model_info: predictData2.model_info || {},
                                                training_status: predictData2.training_status || {},
                                                stock_code: stockCode
                                            });
                                        }
                                    })
                                    .catch(error => {
                                        console.error('[startModelTraining] é‡æ–°è·å–é¢„æµ‹ç»“æœå¤±è´¥:', error);
                                    });
                                }, 2000);
                            }
                        } else {
                            console.log('[startModelTraining] æ²¡æœ‰è¿›åº¦IDï¼Œä¹Ÿæ²¡æœ‰è®­ç»ƒçŠ¶æ€ï¼Œæ˜¾ç¤ºç­‰å¾…ç•Œé¢');
                        }
                    }
                } else {
                    // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    console.error('[startModelTraining] è¯·æ±‚å¤±è´¥:', predictData.message);
                    if (predictionPanel) {
                        predictionPanel.innerHTML = `
                            <div class="alert alert-warning">
                                <h6>âš ï¸ æ— æ³•è·å–æ¨¡å‹é¢„æµ‹æ•°æ®</h6>
                                <p class="mb-0">${predictData.message || 'è¯·ç¨åé‡è¯•'}</p>
                                <p class="mb-0 small text-muted mt-2">å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ–æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('è·å–å¤šæ¨¡å‹é¢„æµ‹å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼‰
                if (predictionPanel) {
                    let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                    if (error.message) {
                        errorMessage = error.message;
                    }
                    predictionPanel.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>âŒ è·å–æ¨¡å‹é¢„æµ‹æ•°æ®å¤±è´¥</h6>
                            <p class="mb-0">${errorMessage}</p>
                            <p class="mb-0 small text-muted mt-2">å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ–æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
                        </div>
                    `;
                }
            });
        }
        
        // è®­ç»ƒè¿›åº¦è½®è¯¢å‡½æ•°
        function startTrainingProgressPolling(progressId) {
            if (!progressId) return;
            
            const pollInterval = 500; // æ¯500msè½®è¯¢ä¸€æ¬¡
            let pollCount = 0;
            const maxPollCount = 120; // æœ€å¤šè½®è¯¢60ç§’ï¼ˆ120 * 500msï¼‰
            
            const pollProgress = () => {
                if (pollCount >= maxPollCount) {
                    console.log('[è®­ç»ƒè¿›åº¦] è½®è¯¢è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢');
                    return;
                }
                
                fetch(`/api/training-progress/${progressId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.progress) {
                            const progress = data.progress;
                            updateTrainingProgressUI(progress);
                            
                            // å¦‚æœè®­ç»ƒå®Œæˆæˆ–å¤±è´¥ï¼Œå¯åŠ¨è¿›åº¦æ¨¡æ‹Ÿç³»ç»Ÿï¼Œè®©è¿›åº¦æ¡ä»0%å¼€å§‹é€æ­¥å¢é•¿åˆ°100%
                            if (progress.status === 'completed' || progress.status === 'failed' || progress.status === 'insufficient_data') {
                                console.log('[è®­ç»ƒè¿›åº¦] è®­ç»ƒå®Œæˆï¼Œå¯åŠ¨è¿›åº¦æ¡æ¨¡æ‹Ÿç³»ç»Ÿ');
                                
                                // å¯åŠ¨è¿›åº¦æ¨¡æ‹Ÿç³»ç»Ÿï¼Œè®©è¿›åº¦æ¡ä»0%å¼€å§‹é€æ­¥å¢é•¿åˆ°100%
                                setTimeout(() => {
                                    startProgressSimulation();
                                }, 100);
                                
                                // è®­ç»ƒå®Œæˆåï¼Œç«‹å³æ˜¾ç¤ºé¢„æµ‹ç»“æœï¼ˆä¸ç­‰å¾…è¿›åº¦æ¡ï¼‰
                                if (progress.status === 'completed') {
                                    console.log('[è®­ç»ƒè¿›åº¦] è®­ç»ƒå®Œæˆï¼Œç«‹å³è·å–å¹¶æ˜¾ç¤ºé¢„æµ‹ç»“æœ');
                                    // è·å–é¢„æµ‹æ•°æ®å¹¶æ˜¾ç¤ºç»“æœ
                                    const predictionPanel = document.getElementById('prediction-panel');
                                    if (predictionPanel) {
                                        // ä»å½“å‰é¡µé¢è·å–è‚¡ç¥¨ä»£ç ï¼ˆä»URLæˆ–å­˜å‚¨çš„å˜é‡ä¸­ï¼‰
                                        const stockCode = window.currentStockCode || '';
                                        if (stockCode) {
                                            // é‡æ–°è·å–é¢„æµ‹ç»“æœå¹¶æ˜¾ç¤º
                                            fetch('/api/multi-model-predict', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({ stock_code: stockCode })
                                            })
                                            .then(response => {
                                                if (!response.ok) {
                                                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                                                }
                                                return response.json();
                                            })
                                            .then(predictData => {
                                                console.log('[è®­ç»ƒè¿›åº¦] è·å–é¢„æµ‹ç»“æœ:', {
                                                    success: predictData.success,
                                                    hasPredictions: !!(predictData.predictions && Object.keys(predictData.predictions || {}).length > 0),
                                                    predictionsCount: predictData.predictions ? Object.keys(predictData.predictions).length : 0,
                                                    predictions: predictData.predictions
                                                });
                                                // åªè¦successä¸ºtrueå°±æ›´æ–°æ•´ä¸ªé¢„æµ‹é¢æ¿
                                                if (predictData.success) {
                                                    const predictionsCount = predictData.predictions ? Object.keys(predictData.predictions).length : 0;
                                                    console.log('[è®­ç»ƒè¿›åº¦] è®­ç»ƒå®Œæˆï¼Œæ›´æ–°é¢„æµ‹é¢æ¿ï¼Œé¢„æµ‹ç»“æœæ•°é‡:', predictionsCount);
                                                    
                                                    // ç›´æ¥æ›´æ–°æ•´ä¸ªprediction-panelçš„å†…å®¹
                                                    const predictionPanel = document.getElementById('prediction-panel');
                                                    if (predictionPanel) {
                                                        // é‡æ–°ç”ŸæˆHTMLï¼ˆåŒ…å«é¢„æµ‹ç»“æœï¼‰
                                                        const newHTML = generatePredictionHTML({
                                                            predictions: predictData.predictions || {},
                                                            training_results: predictData.training_results || {},
                                                            model_info: predictData.model_info || {},
                                                            training_status: predictData.training_status || {},
                                                            progress_id: predictData.progress_id
                                                        }, stockCode);
                                                        
                                                        predictionPanel.innerHTML = newHTML;
                                                        console.log('[è®­ç»ƒè¿›åº¦] âœ… é¢„æµ‹é¢æ¿å·²æ›´æ–°');
                                                    } else {
                                                        console.error('[è®­ç»ƒè¿›åº¦] âŒ prediction-panelä¸å­˜åœ¨');
                                                    }
                                                } else {
                                                    console.error('[è®­ç»ƒè¿›åº¦] è·å–é¢„æµ‹ç»“æœå¤±è´¥:', predictData.message);
                                                }
                                            })
                                            .catch(error => {
                                                console.error('[è®­ç»ƒè¿›åº¦] è·å–é¢„æµ‹ç»“æœå¤±è´¥:', error);
                                            });
                                        } else {
                                            console.error('[è®­ç»ƒè¿›åº¦] æ— æ³•è·å–è‚¡ç¥¨ä»£ç ');
                                        }
                                    } else {
                                        console.error('[è®­ç»ƒè¿›åº¦] prediction-panelä¸å­˜åœ¨');
                                    }
                                }
                                
                                // åœæ­¢è½®è¯¢ï¼ˆè¿›åº¦æ¡æ¨¡æ‹Ÿç³»ç»Ÿä¼šç»§ç»­æ›´æ–°è¿›åº¦æ¡ï¼‰
                                return;
                            }
                            
                            // ç»§ç»­è½®è¯¢
                            pollCount++;
                            setTimeout(pollProgress, pollInterval);
                        } else {
                            console.log('[è®­ç»ƒè¿›åº¦] æ— æ³•è·å–è¿›åº¦ï¼Œåœæ­¢è½®è¯¢');
                        }
                    })
                    .catch(error => {
                        console.error('[è®­ç»ƒè¿›åº¦] è½®è¯¢å‡ºé”™:', error);
                        pollCount++;
                        if (pollCount < maxPollCount) {
                            setTimeout(pollProgress, pollInterval);
                        }
                    });
            };
            
            // å¼€å§‹è½®è¯¢
            setTimeout(pollProgress, pollInterval);
        }
        
        // æ¨¡å‹è¿›åº¦åŠ¨ç”»å­˜å‚¨
        const modelProgressAnimations = {};
        
        // è¿›åº¦æ¡æ¨¡æ‹Ÿç³»ç»Ÿï¼ˆç”¨äºåœ¨è®­ç»ƒå®Œæˆåæ¨¡æ‹Ÿè¿›åº¦æ¡ä»0%åˆ°100%çš„è¿‡ç¨‹ï¼‰
        let progressSimulationInterval = null;
        
        function startProgressSimulation() {
            // å¦‚æœå·²ç»åœ¨è¿è¡Œï¼Œå…ˆæ¸…é™¤
            if (progressSimulationInterval) {
                clearInterval(progressSimulationInterval);
                progressSimulationInterval = null;
            }
            
            console.log('[è¿›åº¦æ¨¡æ‹Ÿ] å¯åŠ¨è¿›åº¦æ¡æ¨¡æ‹Ÿç³»ç»Ÿ');
            const modelNames = ['random_forest', 'gradient_boosting', 'linear_regression', 
                               'ridge', 'lasso', 'xgboost', 'lightgbm'];
            
            // åˆå§‹åŒ–æ‰€æœ‰è¿›åº¦æ¡ä¸º0%
            modelNames.forEach((modelName, index) => {
                const progressBar = document.querySelector(`#model-progress-${modelName} .progress-bar`);
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', '0');
                    progressBar.textContent = 'â³ è®­ç»ƒä¸­...';
                }
            });
            
            // æ¯250msæ›´æ–°ä¸€æ¬¡è¿›åº¦æ¡ï¼ˆæå‡é€Ÿåº¦ï¼‰
            progressSimulationInterval = setInterval(() => {
                let allCompleted = true;
                
                modelNames.forEach((modelName, index) => {
                    const progressBar = document.querySelector(`#model-progress-${modelName} .progress-bar`);
                    if (progressBar) {
                        const currentProgress = parseFloat(progressBar.style.width) || 0;
                        
                        if (currentProgress < 100) {
                            allCompleted = false;
                            
                            // æ¯ä¸ªæ¨¡å‹æœ‰ä¸åŒçš„å¢é•¿é€Ÿåº¦ï¼ˆæå‡é€Ÿåº¦ï¼‰
                            // ç¬¬ä¸€ä¸ªæ¨¡å‹æœ€å¿«ï¼Œæœ€åä¸€ä¸ªæ¨¡å‹æœ€æ…¢
                            const progressIncrement = 5.5 - (index * 0.5); // 5.5%åˆ°2%ä¹‹é—´ï¼ˆæ¯”ä¹‹å‰æ›´å¿«ï¼‰
                            const newProgress = Math.min(100, currentProgress + progressIncrement);
                            
                            // ä½¿ç”¨åŠ¨ç”»å‡½æ•°æ›´æ–°è¿›åº¦æ¡
                            const easingTypes = ['easeIn', 'easeOut', 'easeInOut', 'easeInCubic', 'easeOutCubic', 'easeIn', 'easeOut'];
                            const easingType = easingTypes[index % easingTypes.length];
                            const animationSpeed = 0.15 + (index * 0.08); // 0.15åˆ°0.71ä¹‹é—´ï¼ˆæ¯”ä¹‹å‰ç¨å¿«ï¼‰
                            
                            animateModelProgress(modelName, newProgress, animationSpeed, easingType);
                        }
                    }
                });
                
                // å¦‚æœæ‰€æœ‰è¿›åº¦æ¡éƒ½åˆ°è¾¾100%ï¼Œåœæ­¢æ¨¡æ‹Ÿå¹¶æ˜¾ç¤ºé¢„æµ‹ç»“æœé¢æ¿
                if (allCompleted) {
                    console.log('[è¿›åº¦æ¨¡æ‹Ÿ] æ‰€æœ‰æ¨¡å‹è¿›åº¦æ¡éƒ½åˆ°è¾¾100%ï¼Œåœæ­¢æ¨¡æ‹Ÿ');
                    clearInterval(progressSimulationInterval);
                    progressSimulationInterval = null;
                    
                    // æ˜¾ç¤ºé¢„æµ‹ç»“æœé¢æ¿
                    const predictionResultsContainer = document.querySelector('.prediction-results-container');
                    if (predictionResultsContainer) {
                        predictionResultsContainer.style.display = 'block';
                        console.log('[è¿›åº¦æ¨¡æ‹Ÿ] âœ… é¢„æµ‹ç»“æœé¢æ¿å·²æ˜¾ç¤º');
                        
                        // ç»˜åˆ¶å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ç»˜åˆ¶å‡½æ•°ï¼‰
                        if (window.drawPredictionCharts && typeof window.drawPredictionCharts === 'function') {
                            setTimeout(() => {
                                window.drawPredictionCharts();
                                // ç»˜åˆ¶å®Œæˆåæ¸…é™¤å‡½æ•°å¼•ç”¨
                                window.drawPredictionCharts = null;
                            }, 300);
                        }
                    }
                }
            }, 250); // æ¯250msæ›´æ–°ä¸€æ¬¡ï¼ˆæ¯”ä¹‹å‰çš„400msæ›´å¿«ï¼‰
        }
        
        // å¹³æ»‘æ›´æ–°å•ä¸ªæ¨¡å‹çš„è¿›åº¦æ¡ï¼ˆæ”¯æŒä¸åŒçš„é€Ÿåº¦æ›²çº¿ï¼‰
        function animateModelProgress(modelName, targetProgress, speed = 1, easingType = 'linear') {
            if (!modelProgressAnimations[modelName]) {
                // åˆå§‹åŒ–æ—¶ï¼Œå°è¯•ä»DOMä¸­è¯»å–å½“å‰è¿›åº¦
                const progressBar = document.querySelector(`#model-progress-${modelName} .progress-bar`);
                const currentFromDOM = progressBar ? parseFloat(progressBar.style.width) || 0 : 0;
                modelProgressAnimations[modelName] = { 
                    current: currentFromDOM, 
                    target: currentFromDOM, 
                    speed: speed,
                    easingType: easingType,
                    startProgress: currentFromDOM,
                    startTime: Date.now()
                };
            }
            
            const anim = modelProgressAnimations[modelName];
            const oldTarget = anim.target;
            anim.target = targetProgress;
            anim.speed = speed;
            anim.easingType = easingType;
            
            // å¦‚æœç›®æ ‡å€¼å˜åŒ–ï¼Œé‡ç½®èµ·å§‹å€¼å’Œæ—¶é—´
            if (Math.abs(targetProgress - oldTarget) > 1) {
                anim.startProgress = anim.current;
                anim.startTime = Date.now();
            }
            
            // å¦‚æœå·²ç»åœ¨åŠ¨ç”»ä¸­ï¼Œåªæ›´æ–°ç›®æ ‡å€¼ï¼Œè®©åŠ¨ç”»ç»§ç»­ï¼ˆä¸éœ€è¦é‡æ–°å¯åŠ¨ï¼‰
            if (anim.animationId) {
                return;
            }
            
            // ä¸åŒçš„ç¼“åŠ¨å‡½æ•°
            function easeInOutQuad(t) {
                return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
            }
            
            function easeInQuad(t) {
                return t * t; // å‰é¢å¿«ï¼Œåé¢æ…¢
            }
            
            function easeOutQuad(t) {
                return 1 - (1 - t) * (1 - t); // å‰é¢æ…¢ï¼Œåé¢å¿«
            }
            
            function easeInCubic(t) {
                return t * t * t; // æ›´å¿«çš„åŠ é€Ÿ
            }
            
            function easeOutCubic(t) {
                return 1 - Math.pow(1 - t, 3); // æ›´å¿«çš„å‡é€Ÿ
            }
            
            // å¼€å§‹åŠ¨ç”»
            function updateProgress() {
                const diff = anim.target - anim.startProgress;
                const elapsed = Date.now() - anim.startTime;
                // å¢åŠ åŸºç¡€æŒç»­æ—¶é—´ï¼Œè®©è¿›åº¦æ¡å¢é•¿æ›´æ…¢ã€æ›´æ˜æ˜¾
                // speedè¶Šå°ï¼Œdurationè¶Šé•¿ï¼Œè¿›åº¦æ¡å¢é•¿è¶Šæ…¢
                // ä½¿ç”¨æ›´é•¿çš„æŒç»­æ—¶é—´ï¼Œè®©è¿›åº¦æ¡å¢é•¿æ›´æ…¢ã€æ›´å¹³æ»‘
                const duration = 4000 / anim.speed; // åŸºç¡€æŒç»­æ—¶é—´4ç§’ï¼Œæ ¹æ®speedè°ƒæ•´ï¼ˆspeedè¶Šå°ï¼Œdurationè¶Šé•¿ï¼‰
                
                if (Math.abs(diff) < 0.5) {
                    anim.current = anim.target;
                    anim.animationId = null;
                } else {
                    // è®¡ç®—è¿›åº¦ï¼ˆ0åˆ°1ä¹‹é—´ï¼‰
                    let t = Math.min(1, elapsed / duration);
                    
                    // æ ¹æ®ç¼“åŠ¨ç±»å‹åº”ç”¨ä¸åŒçš„ç¼“åŠ¨å‡½æ•°
                    let easedT = t;
                    switch(anim.easingType) {
                        case 'easeIn':
                            easedT = easeInQuad(t); // å‰é¢å¿«ï¼Œåé¢æ…¢
                            break;
                        case 'easeOut':
                            easedT = easeOutQuad(t); // å‰é¢æ…¢ï¼Œåé¢å¿«
                            break;
                        case 'easeInCubic':
                            easedT = easeInCubic(t);
                            break;
                        case 'easeOutCubic':
                            easedT = easeOutCubic(t);
                            break;
                        case 'easeInOut':
                        default:
                            easedT = easeInOutQuad(t); // å…ˆå¿«åæ…¢å†å¿«
                            break;
                    }
                    
                    // è®¡ç®—å½“å‰è¿›åº¦
                    anim.current = anim.startProgress + diff * easedT;
                    
                    // å¦‚æœè¿˜æ²¡åˆ°è¾¾ç›®æ ‡ï¼Œç»§ç»­åŠ¨ç”»
                    if (t < 1) {
                        anim.animationId = requestAnimationFrame(updateProgress);
                    } else {
                        anim.current = anim.target;
                        anim.animationId = null;
                    }
                }
                
                // æ›´æ–°è¿›åº¦æ¡
                const progressBar = document.querySelector(`#model-progress-${modelName} .progress-bar`);
                if (progressBar) {
                    const progressValue = Math.min(100, Math.max(0, Math.round(anim.current)));
                    progressBar.style.width = `${progressValue}%`;
                    progressBar.setAttribute('aria-valuenow', progressValue);
                    // æ ¹æ®è¿›åº¦ç™¾åˆ†æ¯”æ˜¾ç¤ºæ–‡å­—ï¼š100%æ˜¾ç¤º"å·²å®Œæˆ"ï¼Œå¦åˆ™æ˜¾ç¤º"è®­ç»ƒä¸­"
                    if (progressValue >= 100) {
                        progressBar.textContent = 'âœ… å·²å®Œæˆ';
                    } else {
                        progressBar.textContent = 'â³ è®­ç»ƒä¸­...';
                    }
                } else {
                    // å¦‚æœè¿›åº¦æ¡ä¸å­˜åœ¨ï¼Œåœæ­¢åŠ¨ç”»
                    anim.animationId = null;
                }
            }
            
            anim.animationId = requestAnimationFrame(updateProgress);
        }
        
        // æ›´æ–°è®­ç»ƒè¿›åº¦UI
        function updateTrainingProgressUI(progress) {
            // æ›´æ–°æ­¥éª¤3çš„è¿›åº¦æ¡ï¼ˆå¹³æ»‘é€’å¢ï¼‰
            const step3ProgressBar = document.querySelector('#trainingProgressStep3 .progress-bar');
            if (step3ProgressBar) {
                const targetProgress = progress.progress || 0;
                const currentProgress = parseFloat(step3ProgressBar.style.width) || 0;
                
                // å¹³æ»‘é€’å¢
                if (Math.abs(targetProgress - currentProgress) > 0.5) {
                    const newProgress = currentProgress + (targetProgress - currentProgress) * 0.15;
                    const roundedProgress = Math.round(newProgress);
                    step3ProgressBar.style.width = `${newProgress}%`;
                    step3ProgressBar.setAttribute('aria-valuenow', roundedProgress);
                    // æ ¹æ®è¿›åº¦æ˜¾ç¤ºæ–‡å­—ï¼š100%æ˜¾ç¤º"å·²å®Œæˆ"ï¼Œå¦åˆ™æ˜¾ç¤ºç™¾åˆ†æ¯”
                    step3ProgressBar.textContent = roundedProgress >= 100 ? 'âœ… å·²å®Œæˆ' : `â³ ${roundedProgress}%`;
                } else {
                    step3ProgressBar.style.width = `${targetProgress}%`;
                    step3ProgressBar.setAttribute('aria-valuenow', targetProgress);
                    // æ ¹æ®è¿›åº¦æ˜¾ç¤ºæ–‡å­—ï¼š100%æ˜¾ç¤º"å·²å®Œæˆ"ï¼Œå¦åˆ™æ˜¾ç¤ºç™¾åˆ†æ¯”
                    step3ProgressBar.textContent = targetProgress >= 100 ? 'âœ… å·²å®Œæˆ' : `â³ ${targetProgress}%`;
                }
            }
            
            // æ›´æ–°æ¨¡å‹åˆ—è¡¨ - ä¸ºæ¯ä¸ªæ¨¡å‹æ˜¾ç¤ºç‹¬ç«‹çš„è¿›åº¦æ¡
            const modelListContainer = document.getElementById('trainingModelList');
            if (modelListContainer) {
                const modelNames = ['random_forest', 'gradient_boosting', 'linear_regression', 
                                   'ridge', 'lasso', 'xgboost', 'lightgbm'];
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»ç”Ÿæˆäº†æ¨¡å‹åˆ—è¡¨
                const existingList = modelListContainer.querySelector('.list-group');
                if (!existingList) {
                    // é¦–æ¬¡ç”Ÿæˆæ¨¡å‹åˆ—è¡¨ï¼ˆå³ä½¿æ²¡æœ‰progress.modelsä¹Ÿè¦ç”Ÿæˆï¼Œæ˜¾ç¤ºç­‰å¾…çŠ¶æ€ï¼‰
                    let modelListHTML = '<div class="row mt-3"><div class="col-12"><h6>æ¨¡å‹è®­ç»ƒè¿›åº¦ï¼š</h6><div class="list-group">';
                    
                    modelNames.forEach((modelName, index) => {
                        // è·å–æ¨¡å‹ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
                        const modelInfo = (progress && progress.models && progress.models[modelName]) 
                            ? progress.models[modelName] 
                            : { 
                                name_cn: modelName === 'random_forest' ? 'éšæœºæ£®æ—å›å½’' :
                                        modelName === 'gradient_boosting' ? 'æ¢¯åº¦æå‡å›å½’' :
                                        modelName === 'linear_regression' ? 'çº¿æ€§å›å½’' :
                                        modelName === 'ridge' ? 'Ridgeå›å½’' :
                                        modelName === 'lasso' ? 'Lassoå›å½’' :
                                        modelName === 'xgboost' ? 'XGBoost' :
                                        modelName === 'lightgbm' ? 'LightGBM' : modelName,
                                status: 'pending' 
                            };
                        const statusIcon = modelInfo.status === 'completed' ? 'âœ…' :
                                         modelInfo.status === 'failed' ? 'âŒ' :
                                         modelInfo.status === 'training' || modelInfo.status === 'fitting' || modelInfo.status === 'evaluating' ? 'â³' :
                                         'â¸ï¸';
                        const statusClass = modelInfo.status === 'completed' ? 'list-group-item-success' :
                                          modelInfo.status === 'failed' ? 'list-group-item-danger' :
                                          modelInfo.status === 'training' || modelInfo.status === 'fitting' || modelInfo.status === 'evaluating' ? 'list-group-item-warning' :
                                          'list-group-item-secondary';
                        
                        modelListHTML += `
                            <div class="list-group-item ${statusClass}" id="model-item-${modelName}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong>${statusIcon} ${modelInfo.name_cn || modelName}</strong>
                                        <div id="model-message-${modelName}">
                                            ${modelInfo.message ? `<br><small>${modelInfo.message}</small>` : ''}
                                            ${(modelInfo.val_r2 !== null && modelInfo.val_r2 !== undefined && !isNaN(modelInfo.val_r2)) ? `<br><small class="text-muted">RÂ²: ${Number(modelInfo.val_r2).toFixed(4)}</small>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="progress" style="height: 20px;" id="model-progress-${modelName}">
                                    <div class="progress-bar progress-bar-striped ${modelInfo.status === 'completed' ? 'bg-success' : 
                                                                                  modelInfo.status === 'failed' ? 'bg-danger' : 
                                                                                  'bg-warning progress-bar-animated'}" 
                                         role="progressbar" 
                                         style="width: 0%" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        â³ è®­ç»ƒä¸­...
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    modelListHTML += '</div></div></div>';
                    modelListContainer.innerHTML = modelListHTML;
                }
                
                // æ›´æ–°æ¯ä¸ªæ¨¡å‹çš„çŠ¶æ€å’Œè¿›åº¦
                modelNames.forEach((modelName, index) => {
                    // è·å–æ¨¡å‹ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
                    const modelInfo = (progress && progress.models && progress.models[modelName]) 
                        ? progress.models[modelName] 
                        : { 
                            name_cn: modelName === 'random_forest' ? 'éšæœºæ£®æ—å›å½’' :
                                    modelName === 'gradient_boosting' ? 'æ¢¯åº¦æå‡å›å½’' :
                                    modelName === 'linear_regression' ? 'çº¿æ€§å›å½’' :
                                    modelName === 'ridge' ? 'Ridgeå›å½’' :
                                    modelName === 'lasso' ? 'Lassoå›å½’' :
                                    modelName === 'xgboost' ? 'XGBoost' :
                                    modelName === 'lightgbm' ? 'LightGBM' : modelName,
                            status: 'pending' 
                        };
                    const modelItem = document.getElementById(`model-item-${modelName}`);
                    const modelMessage = document.getElementById(`model-message-${modelName}`);
                    
                    if (modelItem) {
                        // æ›´æ–°çŠ¶æ€å›¾æ ‡å’Œæ ·å¼
                        const statusIcon = modelInfo.status === 'completed' ? 'âœ…' :
                                         modelInfo.status === 'failed' ? 'âŒ' :
                                         modelInfo.status === 'training' || modelInfo.status === 'fitting' || modelInfo.status === 'evaluating' ? 'â³' :
                                         'â¸ï¸';
                        const statusClass = modelInfo.status === 'completed' ? 'list-group-item-success' :
                                          modelInfo.status === 'failed' ? 'list-group-item-danger' :
                                          modelInfo.status === 'training' || modelInfo.status === 'fitting' || modelInfo.status === 'evaluating' ? 'list-group-item-warning' :
                                          'list-group-item-secondary';
                        
                        // æ›´æ–°ç±»å
                        modelItem.className = `list-group-item ${statusClass}`;
                        
                        // æ›´æ–°æ ‡é¢˜ä¸­çš„å›¾æ ‡
                        const titleElement = modelItem.querySelector('strong');
                        if (titleElement) {
                            titleElement.innerHTML = `${statusIcon} ${modelInfo.name_cn || modelName}`;
                        }
                        
                        // æ›´æ–°æ¶ˆæ¯
                        if (modelMessage) {
                            let messageHTML = '';
                            if (modelInfo.message) {
                                messageHTML += `<br><small>${modelInfo.message}</small>`;
                            }
                            if (modelInfo.val_r2 !== null && modelInfo.val_r2 !== undefined && !isNaN(modelInfo.val_r2)) {
                                messageHTML += `<br><small class="text-muted">RÂ²: ${Number(modelInfo.val_r2).toFixed(4)}</small>`;
                            }
                            modelMessage.innerHTML = messageHTML;
                        }
                        
                        // è®¡ç®—å•ä¸ªæ¨¡å‹çš„ç›®æ ‡è¿›åº¦ç™¾åˆ†æ¯”
                        // å…³é”®ï¼šå³ä½¿æ¨¡å‹å·²ç»å®Œæˆï¼Œä¹Ÿè¦ä»0%å¼€å§‹é€æ­¥å¢é•¿ï¼Œæ¨¡æ‹Ÿè®­ç»ƒè¿‡ç¨‹
                        const currentProgressBar = document.querySelector(`#model-progress-${modelName} .progress-bar`);
                        const currentProgress = currentProgressBar ? parseFloat(currentProgressBar.style.width) || 0 : 0;
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ›´æ–°ï¼ˆå½“å‰è¿›åº¦ä¸º0æˆ–å¾ˆå°ï¼‰
                        const isFirstUpdate = currentProgress < 2;
                        
                        let targetProgress = 0;
                        
                        // å¦‚æœæ¨¡å‹å·²ç»å®Œæˆï¼Œæ¨¡æ‹Ÿä»0%åˆ°100%çš„å®Œæ•´è¿‡ç¨‹
                        // å…³é”®ï¼šå³ä½¿æ¨¡å‹å·²å®Œæˆï¼Œä¹Ÿè¦è®©è¿›åº¦æ¡ä»0%å¼€å§‹é€æ­¥å¢é•¿
                        if (modelInfo.status === 'completed') {
                            if (isFirstUpdate) {
                                // ç¬¬ä¸€æ¬¡æ›´æ–°ï¼Œä»0%å¼€å§‹ï¼Œè®¾ç½®ä¸€ä¸ªå¾ˆå°çš„ç›®æ ‡è¿›åº¦
                                targetProgress = 1 + (index * 0.3); // 1-3%ä¹‹é—´ï¼Œæ¯ä¸ªæ¨¡å‹ä¸åŒ
                            } else if (currentProgress < 100) {
                                // é€æ­¥å¢é•¿ï¼Œæ¯æ¬¡æ›´æ–°å¢åŠ ä¸åŒçš„ç™¾åˆ†æ¯”
                                // ç¬¬ä¸€ä¸ªæ¨¡å‹æœ€å¿«ï¼Œæ¯æ¬¡å¢åŠ æ›´å¤šï¼›æœ€åä¸€ä¸ªæ¨¡å‹æœ€æ…¢ï¼Œæ¯æ¬¡å¢åŠ è¾ƒå°‘
                                // ä½¿ç”¨æ›´å¤§çš„å¢é‡ï¼Œè®©è¿›åº¦æ¡å¢é•¿æ›´æ˜æ˜¾
                                const progressIncrement = 5 - (index * 0.5); // 5%åˆ°1.5%ä¹‹é—´ï¼Œç´¢å¼•è¶Šå¤§å¢é‡è¶Šå°
                                targetProgress = Math.min(100, currentProgress + progressIncrement);
                            } else {
                                targetProgress = 100;
                            }
                        } else if (modelInfo.status === 'failed') {
                            targetProgress = 0;
                        } else if (modelInfo.status === 'training' || modelInfo.status === 'fitting' || modelInfo.status === 'evaluating') {
                            // è®­ç»ƒä¸­ï¼Œæ ¹æ®çŠ¶æ€è®¾ç½®ä¸åŒçš„è¿›åº¦èŒƒå›´
                            let baseProgress, maxProgress, progressStep;
                            if (modelInfo.status === 'training') {
                                baseProgress = 10 + (index * 4);
                                maxProgress = 35;
                                progressStep = 3 + (index % 3);
                            } else if (modelInfo.status === 'fitting') {
                                baseProgress = 50 + (index * 2.5);
                                maxProgress = 70;
                                progressStep = 4 + (index % 2);
                            } else { // evaluating
                                baseProgress = 80 + (index * 2);
                                maxProgress = 95;
                                progressStep = 3 + (index % 2);
                            }
                            
                            targetProgress = Math.min(maxProgress, currentProgress + progressStep);
                            if (currentProgress < baseProgress) {
                                targetProgress = baseProgress;
                            }
                        } else if (modelInfo.status === 'pending') {
                            // ç­‰å¾…ä¸­ï¼Œå¦‚æœå½“å‰è¿›åº¦ä¸º0ï¼Œä¿æŒ0ï¼›å¦åˆ™é€æ­¥å¢é•¿
                            if (isFirstUpdate) {
                                targetProgress = 0;
                            } else {
                                targetProgress = Math.min(10, currentProgress + 1);
                            }
                        }
                        
                        // é™åˆ¶åœ¨0-100ä¹‹é—´
                        targetProgress = Math.min(100, Math.max(0, targetProgress));
                        
                        // ä¸ºæ¯ä¸ªæ¨¡å‹è®¾ç½®ä¸åŒçš„åŠ¨ç”»é€Ÿåº¦å’Œç¼“åŠ¨ç±»å‹
                        const easingTypes = ['easeIn', 'easeOut', 'easeInOut', 'easeInCubic', 'easeOutCubic', 'easeIn', 'easeOut'];
                        const easingType = easingTypes[index % easingTypes.length];
                        
                        // ä¸åŒçš„é€Ÿåº¦ï¼ˆç´¢å¼•è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šæ…¢ï¼‰
                        // é€Ÿåº¦èŒƒå›´ä»0.12åˆ°0.72ï¼Œå·®å¼‚æ›´å¤§
                        const animationSpeed = 0.12 + (index * 0.1); // 0.12åˆ°0.72ä¹‹é—´
                        
                        // æ›´æ–°è¿›åº¦æ¡åŠ¨ç”»ï¼ˆä½¿ç”¨setTimeoutè®©ä¸åŒæ¨¡å‹æœ‰å»¶è¿Ÿï¼‰
                        const delay = index * 300; // æ¯ä¸ªæ¨¡å‹å»¶è¿Ÿ300msï¼Œæ€»å…±å»¶è¿Ÿ0-1800ms
                        setTimeout(() => {
                            animateModelProgress(modelName, targetProgress, animationSpeed, easingType);
                        }, delay);
                    }
                });
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®æºå¾½ç« 
        function displayDataSourceBadge(data) {
            const dataSourceBadge = document.getElementById('dataSourceBadge');
            if (dataSourceBadge) {
                const isRealData = data.data_source && data.data_source !== 'mock';
                if (data.data_source_display && data.data_source_display.trim() !== '') {
                    dataSourceBadge.textContent = data.data_source_display;
                    dataSourceBadge.className = `badge ms-2 ${isRealData ? 'bg-success' : 'bg-warning'}`;
                    dataSourceBadge.style.fontSize = '0.7em';
                    dataSourceBadge.title = isRealData ? 'è¿™æ˜¯ä»çœŸå®æ•°æ®æºè·å–çš„æ•°æ®' : 'è¿™æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›å‚è€ƒ';
                } else if (data.data_source === 'mock') {
                    dataSourceBadge.textContent = '';
                    dataSourceBadge.className = 'badge ms-2 bg-warning';
                    dataSourceBadge.style.width = '12px';
                    dataSourceBadge.style.height = '12px';
                    dataSourceBadge.style.borderRadius = '50%';
                    dataSourceBadge.style.padding = '0';
                    dataSourceBadge.title = 'è¿™æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ä¾›å‚è€ƒ';
                } else {
                    dataSourceBadge.style.display = 'none';
                }
            }
        }

        function displayMultiModelResults(data) {
            console.log('[displayMultiModelResults] å¼€å§‹æ˜¾ç¤ºå¤šæ¨¡å‹é¢„æµ‹ç»“æœï¼Œæ•°æ®:', {
                hasPredictions: !!(data.predictions && Object.keys(data.predictions || {}).length > 0),
                predictionsCount: data.predictions ? Object.keys(data.predictions).length : 0,
                stockCode: data.stock_code
            });
            
            // å¦‚æœæ˜¯åœ¨Tabé¡µä¸­ï¼Œæ‰¾åˆ°å¯¹åº”çš„å®¹å™¨
            const container = document.getElementById('multiModelResultsContainer');
            const isInTab = !!container;
            
            console.log('[displayMultiModelResults] æ£€æŸ¥å®¹å™¨ï¼ŒisInTab:', isInTab, 'container:', container);
            
            // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•ï¼ˆå¯èƒ½æ˜¯DOMè¿˜æ²¡æœ‰æ›´æ–°ï¼‰
            if (!container) {
                console.warn('[displayMultiModelResults] å®¹å™¨ä¸å­˜åœ¨ï¼Œç­‰å¾…500msåé‡è¯•');
                setTimeout(() => {
                    const retryContainer = document.getElementById('multiModelResultsContainer');
                    if (retryContainer) {
                        console.log('[displayMultiModelResults] é‡è¯•æˆåŠŸï¼Œæ‰¾åˆ°å®¹å™¨');
                        displayMultiModelResults(data);
                    } else {
                        console.error('[displayMultiModelResults] é‡è¯•å¤±è´¥ï¼Œå®¹å™¨ä»ç„¶ä¸å­˜åœ¨ï¼Œå°è¯•ç›´æ¥åˆ›å»º');
                        // å¦‚æœå®¹å™¨ä»ç„¶ä¸å­˜åœ¨ï¼Œå°è¯•åœ¨prediction-panelä¸­åˆ›å»º
                        const predictionPanel = document.getElementById('prediction-panel');
                        if (predictionPanel) {
                            // åˆ›å»ºå®¹å™¨
                            const newContainer = document.createElement('div');
                            newContainer.id = 'multiModelResultsContainer';
                            predictionPanel.appendChild(newContainer);
                            console.log('[displayMultiModelResults] å·²åˆ›å»ºå®¹å™¨ï¼Œç»§ç»­æ˜¾ç¤ºç»“æœ');
                            displayMultiModelResults(data);
                        } else {
                            console.error('[displayMultiModelResults] prediction-panelä¹Ÿä¸å­˜åœ¨ï¼Œæ— æ³•æ˜¾ç¤ºç»“æœ');
                        }
                    }
                }, 500);
                return;
            }
            
            // å¦‚æœä¸åœ¨Tabé¡µä¸­ï¼Œæ˜¾ç¤ºæ•´ä¸ªç»“æœï¼ˆåŒ…æ‹¬æµç¨‹ï¼‰
            // æ³¨æ„ï¼šç°åœ¨åº”è¯¥æ€»æ˜¯åœ¨Tabé¡µä¸­ï¼Œæ‰€ä»¥ä¸åº”è¯¥è¦†ç›–æ•´ä¸ªresultContent
            if (!isInTab) {
                console.warn('[displayMultiModelResults] è­¦å‘Šï¼šä¸åœ¨Tabé¡µä¸­ï¼Œä½†ä¸ä¼šè¦†ç›–resultContentï¼Œå› ä¸ºç°åœ¨åº”è¯¥ä½¿ç”¨Tabç»“æ„');
                const resultContainer = document.getElementById('resultContainer');
                const resultContent = document.getElementById('resultContent');
                if (resultContainer && resultContent) {
                    resultContainer.style.display = 'block';
                    // ä¸å†è¦†ç›–resultContentï¼Œå› ä¸ºç°åœ¨åº”è¯¥ä½¿ç”¨Tabç»“æ„
                    // å¦‚æœç¡®å®ä¸åœ¨Tabä¸­ï¼Œæ‰æ˜¾ç¤ºå®Œæ•´ç»“æœ
                    const hasTabs = document.getElementById('analysisTabs');
                    if (!hasTabs) {
                        console.log('[displayMultiModelResults] ç¡®å®æ²¡æœ‰Tabç»“æ„ï¼Œæ˜¾ç¤ºå®Œæ•´ç»“æœ');
                    } else {
                        console.log('[displayMultiModelResults] æ£€æµ‹åˆ°Tabç»“æ„ï¼Œä¸è¦†ç›–resultContent');
                        return; // å¦‚æœæœ‰Tabç»“æ„ï¼Œç›´æ¥è¿”å›ï¼Œä¸è¦†ç›–å†…å®¹
                    }
                }
            }

            const predictions = data.predictions || {};
            const stockCode = data.stock_code || '';
            const modelInfo = data.model_info || {};

            const trainingResults = data.training_results || {};
            const trainingStatus = data.training_status || {};
            // æ£€æŸ¥æ˜¯å¦æœ‰è®­ç»ƒç»“æœï¼ˆæ’é™¤errorå­—æ®µï¼‰
            const trainedModels = Object.keys(trainingResults).filter(k => {
                const result = trainingResults[k];
                return result && typeof result === 'object' && !result.error && 
                       (result.train_mae !== undefined || result.val_mae !== undefined);
            });
            const hasTraining = trainingStatus.has_training || trainedModels.length > 0;
            const trainingProgress = trainingStatus.training_progress || 0;
            
            let html = '';
            
            // å¦‚æœä¸åœ¨Tabé¡µä¸­ï¼Œæ˜¾ç¤ºå®Œæ•´çš„æµç¨‹å’Œç»“æœ
            if (!isInTab) {
                html = `
                    <!-- è®­ç»ƒ-é¢„æµ‹æµç¨‹æ­¥éª¤å›¾ -->
                    <div class="card mb-3">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">ğŸ”„ è®­ç»ƒ-é¢„æµ‹æµç¨‹</h5>
                        </div>
                        <div class="card-body">
                            <div class="process-flow">
                                <div class="process-step ${hasTraining ? 'completed' : 'pending'}">
                                    <div class="step-icon">ğŸ“Š</div>
                                    <div class="step-content">
                                        <h6>æ­¥éª¤ 1: æ•°æ®è·å–</h6>
                                        <p class="mb-0">è·å–è‚¡ç¥¨å†å²æ•°æ®å’ŒæŠ€æœ¯æŒ‡æ ‡</p>
                                        <small class="text-muted">${hasTraining ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}</small>
                                    </div>
                                </div>
                                <div class="step-arrow">â†’</div>
                                <div class="process-step ${hasTraining ? 'completed' : 'pending'}">
                                    <div class="step-icon">âš™ï¸</div>
                                    <div class="step-content">
                                        <h6>æ­¥éª¤ 2: ç‰¹å¾å·¥ç¨‹</h6>
                                        <p class="mb-0">æå–ä»·æ ¼ç‰¹å¾ã€æŠ€æœ¯æŒ‡æ ‡ã€æˆäº¤é‡ç‰¹å¾</p>
                                        <small class="text-muted">${hasTraining ? 'âœ… å·²å®Œæˆ' : 'â³ è¿›è¡Œä¸­'}</small>
                                    </div>
                                </div>
                                <div class="step-arrow">â†’</div>
                                <div class="process-step ${hasTraining ? 'completed' : 'pending'}">
                                    <div class="step-icon">ğŸ¤–</div>
                                    <div class="step-content">
                                        <h6>æ­¥éª¤ 3: æ¨¡å‹è®­ç»ƒ</h6>
                                        <p class="mb-0">è®­ç»ƒ ${modelInfo.model_count || Object.keys(predictions).length} ä¸ªæœºå™¨å­¦ä¹ æ¨¡å‹</p>
                                        ${hasTraining ? `
                                            <div class="progress mt-2" style="height: 8px;">
                                                <div class="progress-bar bg-success" role="progressbar" 
                                                     style="width: ${trainingProgress}%" 
                                                     aria-valuenow="${trainingProgress}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <small class="text-muted">âœ… å·²è®­ç»ƒ ${trainedModels.length}/${modelInfo.model_count || Object.keys(predictions).length} ä¸ªæ¨¡å‹ (${trainingProgress}%)</small>
                                        ` : '<small class="text-muted">âš ï¸ æ•°æ®ä¸è¶³ï¼Œä½¿ç”¨ç®€å•é¢„æµ‹</small>'}
                                    </div>
                                </div>
                                <div class="step-arrow">â†’</div>
                                <div class="process-step completed">
                                    <div class="step-icon">ğŸ“ˆ</div>
                                    <div class="step-content">
                                        <h6>æ­¥éª¤ 4: æ¨¡å‹é¢„æµ‹</h6>
                                        <p class="mb-0">ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹é¢„æµ‹æœªæ¥ä»·æ ¼</p>
                                        <small class="text-muted">âœ… å·²å®Œæˆ</small>
                                    </div>
                                </div>
                                <div class="step-arrow">â†’</div>
                                <div class="process-step completed">
                                    <div class="step-icon">ğŸ“Š</div>
                                    <div class="step-content">
                                        <h6>æ­¥éª¤ 5: ç»“æœå±•ç¤º</h6>
                                        <p class="mb-0">å±•ç¤ºå„æ¨¡å‹çš„é¢„æµ‹ç»“æœå’Œå›¾è¡¨</p>
                                        <small class="text-muted">âœ… å·²å®Œæˆ</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">ğŸ¤– å¤šæ¨¡å‹é¢„æµ‹ç»“æœ - ${stockCode}</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>å¯ç”¨æ¨¡å‹æ•°é‡ï¼š</strong> ${modelInfo.model_count || Object.keys(predictions).length}</p>
                            <p class="mb-2"><strong>XGBoostï¼š</strong> ${modelInfo.xgboost_available ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>
                            <p class="mb-0"><strong>LightGBMï¼š</strong> ${modelInfo.lightgbm_available ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>
                        </div>
                    </div>
                `;
            } else {
                // åœ¨Tabé¡µä¸­ï¼Œæ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯å¡ç‰‡ï¼ˆä½†åé¢ä¼šæ·»åŠ æ¯ä¸ªæ¨¡å‹çš„è¯¦ç»†å¡ç‰‡ï¼‰
                html = `
                    <div class="card mb-3">
                        <div class="card-header bg-gradient-primary text-white">
                            <h5 class="mb-0">ğŸ¤– å¤šæ¨¡å‹é¢„æµ‹ç»“æœ - ${stockCode}</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>å¯ç”¨æ¨¡å‹æ•°é‡ï¼š</strong> ${modelInfo.model_count || Object.keys(predictions).length}</p>
                            <p class="mb-2"><strong>XGBoostï¼š</strong> ${modelInfo.xgboost_available ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>
                            <p class="mb-0"><strong>LightGBMï¼š</strong> ${modelInfo.lightgbm_available ? 'âœ… å·²å®‰è£…' : 'âŒ æœªå®‰è£…'}</p>
                        </div>
                    </div>
                `;
            }

            // ä¸ºæ¯ä¸ªæ¨¡å‹åˆ›å»ºå¡ç‰‡å’Œå›¾è¡¨
            const modelColors = {
                'random_forest': '#28a745',
                'gradient_boosting': '#17a2b8',
                'linear_regression': '#ffc107',
                'ridge': '#fd7e14',
                'lasso': '#e83e8c',
                'xgboost': '#6f42c1',
                'lightgbm': '#20c997'
            };

            const modelNames = Object.keys(predictions);
            
            // å¦‚æœæ²¡æœ‰é¢„æµ‹ç»“æœï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (modelNames.length === 0) {
                html += `
                    <div class="alert alert-info">
                        <h6>â³ é¢„æµ‹ç»“æœç”Ÿæˆä¸­...</h6>
                        <p class="mb-0">æ¨¡å‹è®­ç»ƒå·²å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆé¢„æµ‹ç»“æœï¼Œè¯·ç¨å€™ã€‚</p>
                    </div>
                `;
            }
            
            // æ¯ä¸ªæ¨¡å‹å ä¸€è¡Œ
            modelNames.forEach(modelName => {
                const prediction = predictions[modelName];
                const color = modelColors[modelName] || '#007bff';
                const modelNameCn = prediction.model_name_cn || modelName;
                const isTrained = !prediction.is_simple_prediction;

                html += `
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header" style="background-color: ${color}; color: white;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${modelNameCn}</h6>
                                        ${isTrained ? 
                                            '<span class="badge bg-success">å·²è®­ç»ƒ</span>' : 
                                            '<span class="badge bg-warning">ç®€å•é¢„æµ‹</span>'}
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <small><strong>é¢„æœŸæ”¶ç›Šç‡ï¼š</strong></small>
                                            <p class="mb-0" style="color: ${prediction.predicted_return_pct > 0 ? 'red' : 'green'}; font-size: 1.2em; font-weight: bold;">
                                                ${prediction.predicted_return_pct?.toFixed(2) || 0}%
                                            </p>
                                        </div>
                                        <div class="col-md-3">
                                            <small><strong>ç½®ä¿¡åº¦ï¼š</strong></small>
                                            <p class="mb-0" style="font-size: 1.2em; font-weight: bold;">
                                                ${(prediction.confidence * 100)?.toFixed(1) || 0}%
                                            </p>
                                        </div>
                                        <div class="col-md-3">
                                            <small><strong>è¶‹åŠ¿ï¼š</strong></small>
                                            <p class="mb-0">
                                                <span style="color: ${prediction.trend === 'ä¸Šæ¶¨' ? 'red' : 'green'}; font-weight: bold;">
                                                    ${prediction.trend || 'æœªçŸ¥'}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="col-md-3">
                                            <small><strong>é£é™©ç­‰çº§ï¼š</strong></small>
                                            <p class="mb-0">
                                                <span class="badge bg-${prediction.risk_level === 'ä½' ? 'success' : prediction.risk_level === 'ä¸­' ? 'warning' : 'danger'}">
                                                    ${prediction.risk_level || 'æœªçŸ¥'}
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                    <div id="predictionChart_${modelName}" style="height: 350px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // å¦‚æœæ˜¯åœ¨Tabé¡µä¸­ï¼Œåªæ›´æ–°å®¹å™¨å†…å®¹ï¼›å¦åˆ™æ›´æ–°æ•´ä¸ªresultContent
            if (container) {
                console.log('[displayMultiModelResults] æ›´æ–°å®¹å™¨å†…å®¹ï¼Œæ¨¡å‹æ•°é‡:', modelNames.length, 'HTMLé•¿åº¦:', html.length);
                console.log('[displayMultiModelResults] å®¹å™¨å…ƒç´ :', container);
                console.log('[displayMultiModelResults] HTMLå‰500å­—ç¬¦:', html.substring(0, 500));
                container.innerHTML = html;
                console.log('[displayMultiModelResults] âœ… å®¹å™¨å†…å®¹å·²æ›´æ–°ï¼Œå½“å‰å®¹å™¨å†…å®¹é•¿åº¦:', container.innerHTML.length);
                
                // éªŒè¯å†…å®¹æ˜¯å¦çœŸçš„æ›´æ–°äº†
                setTimeout(() => {
                    const verifyContainer = document.getElementById('multiModelResultsContainer');
                    if (verifyContainer && verifyContainer.innerHTML.length > 0) {
                        console.log('[displayMultiModelResults] âœ… éªŒè¯æˆåŠŸï¼Œå®¹å™¨å†…å®¹å·²æ›´æ–°');
                    } else {
                        console.error('[displayMultiModelResults] âŒ éªŒè¯å¤±è´¥ï¼Œå®¹å™¨å†…å®¹ä¸ºç©ºæˆ–æœªæ›´æ–°');
                    }
                }, 100);
            } else {
                console.warn('[displayMultiModelResults] å®¹å™¨ä¸å­˜åœ¨ï¼Œå°è¯•æ›´æ–°resultContent');
                const resultContent = document.getElementById('resultContent');
                if (resultContent) {
                    resultContent.innerHTML = html;
                    console.log('[displayMultiModelResults] âœ… resultContentå·²æ›´æ–°');
                } else {
                    console.error('[displayMultiModelResults] âŒ resultContentä¹Ÿä¸å­˜åœ¨ï¼Œæ— æ³•æ˜¾ç¤ºç»“æœ');
                    // æœ€åå°è¯•ï¼šç›´æ¥åœ¨prediction-panelä¸­æ’å…¥
                    const predictionPanel = document.getElementById('prediction-panel');
                    if (predictionPanel) {
                        console.log('[displayMultiModelResults] å°è¯•ç›´æ¥åœ¨prediction-panelä¸­æ’å…¥å†…å®¹');
                        predictionPanel.insertAdjacentHTML('beforeend', html);
                        console.log('[displayMultiModelResults] âœ… å†…å®¹å·²æ’å…¥åˆ°prediction-panel');
                    } else {
                        console.error('[displayMultiModelResults] âŒ prediction-panelä¹Ÿä¸å­˜åœ¨ï¼Œå®Œå…¨æ— æ³•æ˜¾ç¤ºç»“æœ');
                    }
                }
            }

            // ç»˜åˆ¶æ¯ä¸ªæ¨¡å‹çš„é¢„æµ‹å›¾è¡¨
            if (modelNames.length > 0) {
                console.log('[displayMultiModelResults] å‡†å¤‡ç»˜åˆ¶å›¾è¡¨ï¼Œæ¨¡å‹æ•°é‡:', modelNames.length);
                // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                setTimeout(() => {
                    console.log('[displayMultiModelResults] å¼€å§‹ç»˜åˆ¶å›¾è¡¨ï¼Œæ£€æŸ¥å®¹å™¨...');
                    modelNames.forEach((modelName, index) => {
                        const prediction = predictions[modelName];
                        const chartId = `predictionChart_${modelName}`;
                        
                        // å†æ¬¡æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨
                        setTimeout(() => {
                            const chartElement = document.getElementById(chartId);
                            console.log(`[displayMultiModelResults] æ£€æŸ¥å›¾è¡¨å®¹å™¨ ${chartId}:`, chartElement ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                            
                            if (chartElement) {
                                console.log(`[displayMultiModelResults] ç»˜åˆ¶æ¨¡å‹ ${modelName} çš„å›¾è¡¨ï¼Œæ•°æ®:`, {
                                    hasDates: !!(prediction.prediction_dates && prediction.prediction_dates.length > 0),
                                    hasPrices: !!(prediction.predictions && prediction.predictions.length > 0),
                                    currentPrice: prediction.current_price,
                                    datesCount: prediction.prediction_dates ? prediction.prediction_dates.length : 0,
                                    pricesCount: prediction.predictions ? prediction.predictions.length : 0,
                                    prediction: prediction
                                });
                                
                                // æ£€æŸ¥æ•°æ®æ˜¯å¦å®Œæ•´
                                if (prediction && prediction.predictions && prediction.predictions.length > 0 && 
                                    prediction.prediction_dates && prediction.prediction_dates.length > 0) {
                                    try {
                                        drawSingleModelChart(prediction, chartId, modelColors[modelName] || '#007bff');
                                        console.log(`[displayMultiModelResults] âœ… æ¨¡å‹ ${modelName} å›¾è¡¨ç»˜åˆ¶æˆåŠŸ`);
                                    } catch (error) {
                                        console.error(`[displayMultiModelResults] âŒ æ¨¡å‹ ${modelName} å›¾è¡¨ç»˜åˆ¶å¤±è´¥:`, error);
                                        console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                                    }
                                } else {
                                    console.warn(`[displayMultiModelResults] âš ï¸ æ¨¡å‹ ${modelName} æ•°æ®ä¸å®Œæ•´:`, {
                                        hasPrediction: !!prediction,
                                        hasPredictions: !!(prediction && prediction.predictions),
                                        predictionsLength: prediction && prediction.predictions ? prediction.predictions.length : 0,
                                        hasDates: !!(prediction && prediction.prediction_dates),
                                        datesLength: prediction && prediction.prediction_dates ? prediction.prediction_dates.length : 0
                                    });
                                }
                            } else {
                                console.warn(`[displayMultiModelResults] âš ï¸ å›¾è¡¨å®¹å™¨ ${chartId} ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°æŸ¥æ‰¾`);
                                // å°è¯•å†æ¬¡æŸ¥æ‰¾ï¼ˆå¯èƒ½æ˜¯DOMæ›´æ–°å»¶è¿Ÿï¼‰
                                setTimeout(() => {
                                    const retryElement = document.getElementById(chartId);
                                    if (retryElement) {
                                        if (prediction && prediction.predictions && prediction.predictions.length > 0) {
                                            console.log(`[displayMultiModelResults] é‡è¯•æˆåŠŸï¼Œç»˜åˆ¶æ¨¡å‹ ${modelName} çš„å›¾è¡¨`);
                                            try {
                                                drawSingleModelChart(prediction, chartId, modelColors[modelName] || '#007bff');
                                                console.log(`[displayMultiModelResults] âœ… æ¨¡å‹ ${modelName} å›¾è¡¨ç»˜åˆ¶æˆåŠŸï¼ˆé‡è¯•ï¼‰`);
                                            } catch (error) {
                                                console.error(`[displayMultiModelResults] âŒ æ¨¡å‹ ${modelName} å›¾è¡¨ç»˜åˆ¶å¤±è´¥ï¼ˆé‡è¯•ï¼‰:`, error);
                                            }
                                        } else {
                                            console.warn(`[displayMultiModelResults] âš ï¸ æ¨¡å‹ ${modelName} æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•ç»˜åˆ¶`);
                                        }
                                    } else {
                                        console.error(`[displayMultiModelResults] âŒ é‡è¯•å¤±è´¥ï¼Œå›¾è¡¨å®¹å™¨ ${chartId} ä»ç„¶ä¸å­˜åœ¨`);
                                    }
                                }, 500);
                            }
                        }, index * 150); // æ¯ä¸ªæ¨¡å‹é—´éš”150msï¼Œé¿å…åŒæ—¶ç»˜åˆ¶å¯¼è‡´é—®é¢˜
                    });
                }, 500); // å¢åŠ å»¶è¿Ÿåˆ°500msï¼Œç¡®ä¿DOMå®Œå…¨æ›´æ–°
            } else {
                console.warn('[displayMultiModelResults] æ²¡æœ‰æ¨¡å‹é¢„æµ‹ç»“æœï¼Œä¸ç»˜åˆ¶å›¾è¡¨');
            }

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸï¼ˆå¦‚æœä¸åœ¨Tabé¡µä¸­ï¼‰
            if (!container) {
                const resultContainer = document.getElementById('resultContainer');
                if (resultContainer) {
                    resultContainer.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }

        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æ˜¯å‘¨æœ«
        function isWeekend(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDay();
            return day === 0 || day === 6; // 0=å‘¨æ—¥, 6=å‘¨å…­
        }
        
        // è·å–å‰ä¸€ä¸ªäº¤æ˜“æ—¥
        function getPreviousTradingDay(dateStr) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() - 1);
            while (isWeekend(date.toISOString().split('T')[0])) {
                date.setDate(date.getDate() - 1);
            }
            return date.toISOString().split('T')[0];
        }
        
        function drawSingleModelChart(prediction, chartId, color) {
            const dates = prediction.prediction_dates || [];
            const prices = prediction.predictions || [];
            const currentPrice = prediction.current_price || 0;

            // æ·»åŠ å½“å‰ä»·æ ¼ä½œä¸ºèµ·ç‚¹
            const today = formatDateSimple(new Date());
            const formattedDates = dates.map(d => formatDateSimple(d));
            
            // å¤„ç†å‘¨æœ«ï¼šå¦‚æœæ˜¯å‘¨æœ«ï¼Œä½¿ç”¨å‰ä¸€ä¸ªäº¤æ˜“æ—¥çš„ä»·æ ¼ï¼Œå¹¶ç”¨é»‘è‰²è™šçº¿è¿æ¥
            const allDates = [today];
            const allPrices = [currentPrice];
            const weekendConnections = []; // å­˜å‚¨éœ€è¦é»‘è‰²è™šçº¿è¿æ¥çš„æ—¥æœŸå¯¹
            
            let lastTradingPrice = currentPrice;
            let lastTradingDate = today;
            
            // å¤„ç†æ—¥æœŸï¼Œæ ‡è®°å‘¨æœ«
            const dateLabels = []; // å­˜å‚¨å¸¦æ ‡ç­¾çš„æ—¥æœŸï¼ˆç”¨äºXè½´æ˜¾ç¤ºï¼‰
            formattedDates.forEach((dateStr, index) => {
                if (isWeekend(dateStr)) {
                    // å¦‚æœæ˜¯å‘¨æœ«ï¼Œä½¿ç”¨å‰ä¸€ä¸ªäº¤æ˜“æ—¥çš„ä»·æ ¼ï¼Œå¹¶åœ¨æ—¥æœŸæ ‡ç­¾ä¸Šæ ‡è®°ï¼ˆå‘¨æœ«ï¼‰
                    const prevTradingDay = getPreviousTradingDay(dateStr);
                    allDates.push(dateStr);
                    allPrices.push(lastTradingPrice);
                    dateLabels.push(`${dateStr}ï¼ˆå‘¨æœ«ï¼‰`); // æ ‡è®°å‘¨æœ«
                    // è®°å½•éœ€è¦é»‘è‰²è™šçº¿è¿æ¥çš„æ—¥æœŸå¯¹
                    weekendConnections.push({
                        from: lastTradingDate,
                        to: dateStr,
                        price: lastTradingPrice
                    });
                } else {
                    // æ­£å¸¸äº¤æ˜“æ—¥
                    allDates.push(dateStr);
                    allPrices.push(prices[index]);
                    dateLabels.push(dateStr); // æ­£å¸¸æ—¥æœŸï¼Œä¸æ ‡è®°
                    lastTradingPrice = prices[index];
                    lastTradingDate = dateStr;
                }
            });
            
            // å°†ä»Šå¤©çš„æ—¥æœŸä¹Ÿæ·»åŠ åˆ°æ ‡ç­¾æ•°ç»„ï¼ˆç¬¬ä¸€ä¸ªï¼‰
            const todayLabel = isWeekend(today) ? `${today}ï¼ˆå‘¨æœ«ï¼‰` : today;
            const allDateLabels = [todayLabel, ...dateLabels];
            
            // è®¡ç®—Yè½´èŒƒå›´ï¼ˆä¸ä»0å¼€å§‹ï¼Œè®©æ³¢åŠ¨æ›´æ˜æ˜¾ï¼‰
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);
            const priceRange = maxPrice - minPrice;
            const yAxisMin = Math.max(0, minPrice - priceRange * 0.1); // ç•™10%çš„è¾¹è·
            const yAxisMax = maxPrice + priceRange * 0.1;

            // ä¸»é¢„æµ‹ä»·æ ¼çº¿ï¼ˆæŠ˜çº¿å›¾ï¼Œä¸å¡«å……ï¼‰
            const trace = {
                x: allDates,
                y: allPrices,
                mode: 'lines+markers',
                name: 'é¢„æµ‹ä»·æ ¼',
                line: { color: color, width: 2 },
                marker: { size: 8, color: color }
                // ç§»é™¤ fill å’Œ fillcolorï¼Œåªæ˜¾ç¤ºæŠ˜çº¿å›¾
            };
            
            // æ·»åŠ å‘¨æœ«çš„é»‘è‰²è™šçº¿è¿æ¥
            const weekendTraces = weekendConnections.map(conn => {
                const fromIndex = allDates.indexOf(conn.from);
                const toIndex = allDates.indexOf(conn.to);
                if (fromIndex >= 0 && toIndex >= 0) {
                    return {
                        x: [conn.from, conn.to],
                        y: [conn.price, conn.price],
                        mode: 'lines',
                        name: 'éäº¤æ˜“æ—¥',
                        line: { 
                            color: 'black', 
                            width: 2, 
                            dash: 'dash' // è™šçº¿
                        },
                        showlegend: false,
                        hoverinfo: 'skip'
                    };
                }
                return null;
            }).filter(t => t !== null);

            const layout = {
                title: {
                    text: prediction.model_name_cn || 'é¢„æµ‹è¶‹åŠ¿',
                    font: { size: 14 }
                },
                xaxis: { 
                    title: 'æ—¥æœŸ',
                    tickmode: 'array',
                    tickvals: allDates,
                    ticktext: allDateLabels // ä½¿ç”¨å¸¦ï¼ˆå‘¨æœ«ï¼‰æ ‡è®°çš„æ—¥æœŸæ ‡ç­¾
                },
                yaxis: { 
                    title: 'ä»·æ ¼ï¼ˆå…ƒï¼‰',
                    range: [yAxisMin, yAxisMax] // è®¾ç½®Yè½´èŒƒå›´ï¼Œä¸ä»0å¼€å§‹
                },
                hovermode: 'closest',
                template: 'plotly_white',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: {color: '#333'},
                margin: { l: 50, r: 20, t: 40, b: 50 },
                modebar: {
                    orientation: 'v', // å‚ç›´æ˜¾ç¤ºå·¥å…·æ 
                    bgcolor: 'rgba(255,255,255,0.8)',
                    color: '#333',
                    activecolor: '#007bff'
                }
            };
            
            // é…ç½®å·¥å…·æ å§‹ç»ˆæ˜¾ç¤º
            const config = {
                responsive: true,
                displayModeBar: true, // æ˜¾ç¤ºå·¥å…·æ 
                displaylogo: false, // éšè—Plotly logo
                modeBarButtonsToRemove: ['lasso2d', 'select2d'], // ç§»é™¤ä¸éœ€è¦çš„æŒ‰é’®
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'stock_prediction',
                    height: 500,
                    width: 800,
                    scale: 1
                }
            };

            Plotly.newPlot(chartId, [trace, ...weekendTraces], layout, config);
        }
        
        // ç”Ÿæˆå†³ç­–è§£é‡Š
        function generateDecisionExplanation(data) {
            const explanationDiv = document.getElementById('decisionExplanation');
            if (!explanationDiv) return;
            
            // å‡†å¤‡æ•°æ®
            const decision = data.decision || {};
            const visualization = data.visualization || {};
            const stockData = data.stock_data || [];
            const stockCode = data.stock_code || '';
            
            // æå–æŠ€æœ¯æŒ‡æ ‡åˆ†æä¿¡æ¯
            const technicalIndicators = extractTechnicalIndicators(stockData);
            
            // æå–è§„åˆ™è¯„ä¼°ä¿¡æ¯
            const ruleEvaluation = extractRuleEvaluation(visualization, decision);
            
            // è°ƒç”¨åç«¯APIç”ŸæˆAIå†³ç­–è§£é‡Š
            fetch('/api/decision-explanation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    stock_code: stockCode,
                    decision: decision,
                    rule_evaluation: ruleEvaluation,
                    technical_indicators: technicalIndicators
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.explanation) {
                    // æå–å†³ç­–æµç¨‹ä¿¡æ¯
                    const decisionProcess = decision.decision_process || [];
                    const riskAssessment = decision.risk_assessment || {};
                    const strategy = decision.strategy || {};
                    const ruleAdjustments = decision.rule_adjustments || {};
                    
                    displayDecisionExplanation(
                        result.explanation, 
                        ruleEvaluation, 
                        technicalIndicators,
                        decisionProcess,
                        riskAssessment,
                        strategy,
                        ruleAdjustments
                    );
                } else {
                    // å¦‚æœåç«¯è¿”å›å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const errorMsg = result.explanation || 'ç”Ÿæˆå†³ç­–è§£é‡Šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    explanationDiv.innerHTML = `<div class="alert alert-warning">${errorMsg}</div>`;
                    console.error('å†³ç­–è§£é‡Šç”Ÿæˆå¤±è´¥:', result);
                }
            })
            .catch(error => {
                console.error('ç”Ÿæˆå†³ç­–è§£é‡Šå¤±è´¥:', error);
                explanationDiv.innerHTML = '<div class="alert alert-warning">ç”Ÿæˆå†³ç­–è§£é‡Šå¤±è´¥ï¼Œè¯·ç¡®ä¿AIæœåŠ¡å·²å¯åŠ¨ã€‚</div>';
            });
        }
        
        // æå–æŠ€æœ¯æŒ‡æ ‡åˆ†æä¿¡æ¯
        function extractTechnicalIndicators(stockData) {
            if (!stockData || stockData.length === 0) return [];
            
            const last = stockData[stockData.length - 1];
            const indicators = [];
            
            // MACDåˆ†æ
            if (last.macd !== null && last.macd_signal !== null) {
                const macdVal = last.macd || 0;
                const signalVal = last.macd_signal || 0;
                if (macdVal > signalVal) {
                    indicators.push('MACDæŒ‡æ ‡ï¼šMACDçº¿åœ¨ä¿¡å·çº¿ä¸Šæ–¹ï¼Œæ˜¾ç¤ºä¹°å…¥ä¿¡å·');
                } else {
                    indicators.push('MACDæŒ‡æ ‡ï¼šMACDçº¿åœ¨ä¿¡å·çº¿ä¸‹æ–¹ï¼Œæ˜¾ç¤ºå–å‡ºä¿¡å·');
                }
            }
            
            // RSIåˆ†æ
            if (last.rsi !== null) {
                const rsi = last.rsi;
                if (rsi > 70) {
                    indicators.push(`RSIæŒ‡æ ‡ï¼šå½“å‰å€¼${rsi.toFixed(2)}ï¼Œå¤„äºè¶…ä¹°åŒºåŸŸï¼Œå»ºè®®è°¨æ…`);
                } else if (rsi < 30) {
                    indicators.push(`RSIæŒ‡æ ‡ï¼šå½“å‰å€¼${rsi.toFixed(2)}ï¼Œå¤„äºè¶…å–åŒºåŸŸï¼Œå¯èƒ½å­˜åœ¨æœºä¼š`);
                } else {
                    indicators.push(`RSIæŒ‡æ ‡ï¼šå½“å‰å€¼${rsi.toFixed(2)}ï¼Œå¤„äºæ­£å¸¸åŒºé—´`);
                }
            }
            
            // å¸ƒæ—å¸¦åˆ†æ
            if (last.close !== null && last.bb_upper !== null && last.bb_lower !== null) {
                const close = last.close;
                const upper = last.bb_upper;
                const lower = last.bb_lower;
                if (close > upper) {
                    indicators.push('å¸ƒæ—å¸¦æŒ‡æ ‡ï¼šä»·æ ¼çªç ´ä¸Šè½¨ï¼Œå¯èƒ½é¢ä¸´å›è°ƒ');
                } else if (close < lower) {
                    indicators.push('å¸ƒæ—å¸¦æŒ‡æ ‡ï¼šä»·æ ¼è·Œç ´ä¸‹è½¨ï¼Œå¯èƒ½å­˜åœ¨åå¼¹æœºä¼š');
                } else {
                    indicators.push('å¸ƒæ—å¸¦æŒ‡æ ‡ï¼šä»·æ ¼åœ¨å¸ƒæ—å¸¦å†…è¿è¡Œï¼Œè¶‹åŠ¿æ­£å¸¸');
                }
            }
            
            // KDJåˆ†æ
            if (last.kdj_k !== null && last.kdj_d !== null) {
                const k = last.kdj_k;
                const d = last.kdj_d;
                if (k > d) {
                    indicators.push('KDJæŒ‡æ ‡ï¼šKçº¿åœ¨Dçº¿ä¸Šæ–¹ï¼Œæ˜¾ç¤ºçŸ­æœŸä¸Šæ¶¨ä¿¡å·');
                } else {
                    indicators.push('KDJæŒ‡æ ‡ï¼šKçº¿åœ¨Dçº¿ä¸‹æ–¹ï¼Œæ˜¾ç¤ºçŸ­æœŸä¸‹è·Œä¿¡å·');
                }
            }
            
            // ç§»åŠ¨å¹³å‡çº¿åˆ†æ
            if (last.ma5 !== null && last.ma10 !== null && last.ma20 !== null && last.close !== null) {
                const close = last.close;
                if (close > last.ma5 && last.ma5 > last.ma10 && last.ma10 > last.ma20) {
                    indicators.push('å‡çº¿ç³»ç»Ÿï¼šå¤šå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸Š');
                } else if (close < last.ma5 && last.ma5 < last.ma10 && last.ma10 < last.ma20) {
                    indicators.push('å‡çº¿ç³»ç»Ÿï¼šç©ºå¤´æ’åˆ—ï¼Œè¶‹åŠ¿å‘ä¸‹');
                }
            }
            
            return indicators;
        }
        
        // æå–è§„åˆ™è¯„ä¼°ä¿¡æ¯
        function extractRuleEvaluation(visualization, decision) {
            const evaluation = {
                triggered_rules: [],
                is_allowed: visualization.is_allowed !== false,
                reason: visualization.reason || '',
                total_rules: visualization.total_rules || 0,
                triggered_count: visualization.triggered_rules || 0
            };
            
            // æå–è§¦å‘çš„è§„åˆ™è¯¦æƒ…
            if (visualization.steps && Array.isArray(visualization.steps)) {
                visualization.steps.forEach(step => {
                    if (step.is_triggered) {
                        evaluation.triggered_rules.push({
                            rule_id: step.rule_id || '',
                            rule_name: step.rule_name || '',
                            rule_type: step.rule_type || '',
                            description: step.description || '',
                            action: step.action || {}
                        });
                    }
                });
            }
            
            // æ·»åŠ è­¦å‘Šå’Œä¼˜åŒ–å»ºè®®
            const ruleEval = decision.rule_evaluation || {};
            if (ruleEval.warnings && Array.isArray(ruleEval.warnings)) {
                evaluation.warnings = ruleEval.warnings;
            }
            if (ruleEval.optimizations && Array.isArray(ruleEval.optimizations)) {
                evaluation.optimizations = ruleEval.optimizations;
            }
            
            return evaluation;
        }
        
        // æ˜¾ç¤ºå†³ç­–è§£é‡Š
        function displayDecisionExplanation(aiExplanation, ruleEvaluation, technicalIndicators, decisionProcess, riskAssessment, strategy, ruleAdjustments) {
            const explanationDiv = document.getElementById('decisionExplanation');
            if (!explanationDiv) return;
            
            let html = '';
            
            // æ˜¾ç¤ºå¤æ‚ä¸šåŠ¡é€»è¾‘å†³ç­–æµç¨‹ï¼ˆ7é˜¶æ®µï¼‰
            if (decisionProcess && decisionProcess.length > 0) {
                html += '<div class="mb-4">';
                html += '<div class="mb-3"><strong>ğŸ” å¤æ‚ä¸šåŠ¡é€»è¾‘å†³ç­–æµç¨‹ï¼ˆ7é˜¶æ®µï¼‰ï¼š</strong></div>';
                decisionProcess.forEach((stage, index) => {
                    const stageResult = stage.result || {};
                    const statusIcon = stageResult.passed !== false ? 'âœ…' : 'âŒ';
                    const statusColor = stageResult.passed !== false ? '#28a745' : '#dc3545';
                    
                    html += `<div class="evidence-item" style="margin-bottom: 10px;">`;
                    html += `<strong style="color: ${statusColor};">${statusIcon} é˜¶æ®µ${index + 1}ï¼š${stage.stage}</strong>`;
                    
                    // æ˜¾ç¤ºé˜¶æ®µè¯¦æƒ…
                    if (stage.stage === 'é£é™©è¯„ä¼°' && riskAssessment) {
                        html += `<div style="margin-top: 8px; padding-left: 15px;">`;
                        html += `<div>ç»¼åˆé£é™©è¯„åˆ†ï¼š<strong>${riskAssessment.total_risk_score?.toFixed(2) || 'N/A'}</strong>ï¼ˆ${riskAssessment.risk_level || 'ä¸­'}é£é™©ï¼‰</div>`;
                        if (riskAssessment.risk_factors && riskAssessment.risk_factors.length > 0) {
                            html += `<div style="margin-top: 5px; font-size: 0.9em;">é£é™©ç»´åº¦ï¼š`;
                            riskAssessment.risk_factors.forEach(factor => {
                                html += `<span style="margin-left: 8px;">${factor.factor}(${factor.score.toFixed(2)})</span>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    } else if (stage.stage === 'è§„åˆ™å‚æ•°è°ƒæ•´' && ruleAdjustments) {
                        html += `<div style="margin-top: 8px; padding-left: 15px; font-size: 0.9em;">`;
                        for (const [key, adjustment] of Object.entries(ruleAdjustments)) {
                            html += `<div>â€¢ ${key}ï¼š${adjustment.original} â†’ ${adjustment.adjusted}ï¼ˆ${adjustment.reason}ï¼‰</div>`;
                        }
                        html += `</div>`;
                    } else if (stage.stage === 'ç­–ç•¥é€‰æ‹©' && strategy) {
                        html += `<div style="margin-top: 8px; padding-left: 15px;">`;
                        html += `<div>é€‰æ‹©ç­–ç•¥ï¼š<strong>${strategy.name}</strong></div>`;
                        html += `<div style="font-size: 0.9em; color: #666;">${strategy.description}</div>`;
                        if (strategy.selection_reason) {
                            html += `<div style="font-size: 0.9em; color: #666; margin-top: 3px;">é€‰æ‹©åŸå› ï¼š${strategy.selection_reason}</div>`;
                        }
                        html += `</div>`;
                    } else if (stageResult.reason || stageResult.description) {
                        html += `<div style="margin-top: 5px; padding-left: 15px; color: #666; font-size: 0.9em;">`;
                        html += stageResult.reason || stageResult.description || '';
                        html += `</div>`;
                    }
                    html += `</div>`;
                });
                html += '</div>';
            }
            
            // æ˜¾ç¤ºè§„åˆ™è¯„ä¼°è®ºæ®
            if (ruleEvaluation.triggered_rules && ruleEvaluation.triggered_rules.length > 0) {
                html += '<div class="mb-3"><strong>è§„åˆ™è¯„ä¼°åˆ†æï¼š</strong></div>';
                ruleEvaluation.triggered_rules.forEach(rule => {
                    html += `<div class="evidence-item">`;
                    html += `<strong>è§„åˆ™${rule.rule_id}ï¼ˆ${rule.rule_name}ï¼‰ï¼š</strong>${rule.description || ''}`;
                    if (rule.action && rule.action.message) {
                        html += ` <span style="color: #d32f2f;">â†’ ${rule.action.message}</span>`;
                    }
                    html += `</div>`;
                });
            }
            
            // æ˜¾ç¤ºæŠ€æœ¯æŒ‡æ ‡åˆ†æè®ºæ®
            if (technicalIndicators && technicalIndicators.length > 0) {
                html += '<div class="mb-3 mt-4"><strong>æŠ€æœ¯æŒ‡æ ‡åˆ†æï¼š</strong></div>';
                technicalIndicators.forEach(indicator => {
                    html += `<div class="evidence-item">${indicator}</div>`;
                });
            }
            
            // æ˜¾ç¤ºè­¦å‘Šå’Œä¼˜åŒ–å»ºè®®
            if (ruleEvaluation.warnings && ruleEvaluation.warnings.length > 0) {
                html += '<div class="mb-3 mt-4"><strong>è­¦å‘Šä¿¡æ¯ï¼š</strong></div>';
                ruleEvaluation.warnings.forEach(warning => {
                    html += `<div class="evidence-item" style="border-left-color: #f57c00;">`;
                    html += `<strong>âš ï¸ è­¦å‘Šï¼š</strong>${warning.message || ''}`;
                    html += `</div>`;
                });
            }
            
            if (ruleEvaluation.optimizations && ruleEvaluation.optimizations.length > 0) {
                html += '<div class="mb-3 mt-4"><strong>ä¼˜åŒ–å»ºè®®ï¼š</strong></div>';
                ruleEvaluation.optimizations.forEach(opt => {
                    html += `<div class="evidence-item" style="border-left-color: #388e3c;">`;
                    html += `<strong>ğŸ’¡ å»ºè®®ï¼š</strong>${opt.message || ''}`;
                    html += `</div>`;
                });
            }
            
            // æ˜¾ç¤ºAIæœ€ç»ˆå†³ç­–
            if (aiExplanation) {
                html += '<div class="final-decision">';
                html += '<div class="final-decision-title">ğŸ¤– AIæœ€ç»ˆå†³ç­–åˆ†æ</div>';
                html += '<div>' + aiExplanation.replace(/\n/g, '<br>') + '</div>';
                html += '</div>';
            }
            
            explanationDiv.innerHTML = html;
        }
    </script>
</body>
</html>

